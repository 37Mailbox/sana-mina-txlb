<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è·³ä¸‹æ¥å§ - 17å²çš„æ˜¥å¤©</title>
    <style>
        /* =========================================
           1. å…¨å±€æ ·å¼ & å˜é‡å®šä¹‰
           ========================================= */
        :root {
            --sana-main: #f9e4ff;  
            --sana-deep: #9d72b0;  
            --mina-main: #c4ffdd;  
            --mina-deep: #56ab83;
            --text-color: #2c3e50;
            --glass: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.8);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        body { 
            margin: 0; padding: 0; background-color: #000; 
            font-family: "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif; 
            height: 100vh; width: 100vw; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            user-select: none;
        }

        #game-container {
            width: 960px; height: 540px; 
            background: #222; position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,1); 
            overflow: hidden;
            transform-origin: center center;
        }

        /* --- 0. åŸºç¡€å±‚ --- */
        .bg-layer { position: absolute; inset: 0; background-color: #333; background-size: cover; background-position: center; transition: opacity 1s; z-index: 0; }
        .vignette { position: absolute; inset: 0; background: radial-gradient(circle, transparent 70%, rgba(0,0,0,0.4) 100%); pointer-events: none; z-index: 2; }
        
        /* å¿«è¿›æç¤º */
        #skip-indicator {
            position: absolute; top: 20px; left: 20px;
            color: var(--sana-deep); background: rgba(255,255,255,0.8);
            padding: 5px 15px; border-radius: 20px;
            font-size: 16px; font-weight: bold;
            z-index: 300; display: none; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            animation: pulse 0.8s infinite alternate;
            pointer-events: none;
        }
        @keyframes pulse { from { opacity: 1; transform: scale(1); } to { opacity: 0.6; transform: scale(0.95); } }

        /* --- 1. è§’è‰²ç«‹ç»˜å±‚ --- */
        .sprite-layer { 
            position: absolute; bottom: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 10; 
            display: flex; justify-content: center; align-items: flex-end; 
        }
        .char-img { 
            width: 400px; height: 600px; margin: 0 -40px; display: none; 
            background-repeat: no-repeat; background-position: center bottom; background-size: contain;
            transition: all 0.4s ease; 
        } 
        #char-sana { background-image: url('https://via.placeholder.com/400x800/f9e4ff/9d72b0?text=Sana'); }
        #char-mina { background-image: url('https://via.placeholder.com/400x800/c4ffdd/56ab83?text=Mina'); }
        
        .active { filter: brightness(1.05) drop-shadow(0 0 10px rgba(255,255,255,0.3)); transform: scale(1.02) translateY(0); z-index: 12; }
        .inactive { filter: brightness(0.6) grayscale(0.3); transform: scale(0.96) translateY(10px); z-index: 11; }

        /* --- 2. NVL æ¨¡å¼ --- */
        #nvl-layer {
            position: absolute; top: auto; bottom: 0; left: 0; right: 0; height: auto; max-height: 45%; 
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 60%, transparent 100%);
            backdrop-filter: none; z-index: 40;
            padding: 30px 120px 50px 120px; 
            display: none; flex-direction: column; justify-content: flex-end; align-items: flex-start;
        }
        .nvl-text {
            font-size: 20px; line-height: 1.7; color: rgba(255, 255, 255, 0.95);
            margin-bottom: 12px; text-align: left; font-weight: 400; text-shadow: 0 1px 4px rgba(0,0,0,0.5);
        }

        /* --- 3. ADV æ¨¡å¼ --- */
        #adv-box {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 900px; height: 150px;
            background: var(--glass); border: 2px solid var(--glass-border);
            border-radius: 16px; z-index: 50; padding: 20px 30px; box-sizing: border-box; 
            display: flex; flex-direction: column; box-shadow: var(--shadow); transition: opacity 0.3s;
        }
        #name-box { 
            align-self: flex-start; padding: 4px 15px; border-radius: 12px;
            font-size: 16px; font-weight: bold; margin-bottom: 8px; color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); background: #888;
        }
        .name-sana { background: var(--sana-deep) !important; }
        .name-mina { background: var(--mina-deep) !important; }
        #text-box { font-size: 20px; line-height: 1.5; color: var(--text-color); flex-grow: 1; }

        /* å…‰æ ‡åŠ¨ç”» */
        .cursor { display: inline-block; width: 10px; height: 10px; background: var(--sana-deep); border-radius: 50%; margin-left: 10px; opacity: 0; animation: blink 1s infinite; }
        .cursor.show { opacity: 1; }
        @keyframes blink { 50% { opacity: 0.2; } }

        /* --- 4. ç³»ç»Ÿ UI --- */
        .top-bar {
            position: absolute; top: 0; width: 100%; height: 50px; z-index: 200;
            display: flex; justify-content: flex-end; align-items: center; padding-right: 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.3), transparent);
        }
        .sys-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); 
            color: #fff; border-radius: 20px; padding: 5px 15px; margin-left: 10px;
            cursor: pointer; font-size: 13px; transition: 0.2s; backdrop-filter: blur(2px);
        }
        .sys-btn:hover { background: #fff; color: var(--sana-deep); }

        /* --- 5. é€šç”¨è¦†ç›–å±‚ --- */
        .overlay-screen {
            position: absolute; inset: 0; background: rgba(255,255,255,0.98); z-index: 300; 
            display: none; flex-direction: column; align-items: center; justify-content: center;
            color: #333; backdrop-filter: blur(5px);
        }
        .overlay-title { font-size: 32px; color: var(--sana-deep); margin-bottom: 20px; border-bottom: 2px solid var(--mina-main); padding-bottom: 10px; }
        
        .close-btn { padding: 10px 30px; background: #333; color: #fff; border: none; border-radius: 20px; cursor: pointer; margin-top: 20px; }
        
        /* å­˜æ¡£æ§½ä½ */
        .save-slots { display: flex; gap: 20px; margin-bottom: 20px; }
        .slot-card {
            width: 200px; height: 140px; background: #fff; border: 1px solid #ddd; 
            border-radius: 10px; padding: 15px; cursor: pointer;
            display: flex; flex-direction: column; justify-content: space-between; 
            transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .slot-card:hover { transform: translateY(-5px); border-color: var(--sana-deep); }
        .slot-id { font-weight: bold; color: var(--sana-deep); }
        .slot-preview { font-size: 12px; color: #666; flex-grow: 1; margin: 10px 0; overflow: hidden; height: 50px; }
        .slot-date { font-size: 11px; color: #999; text-align: right; }

        /* éŸ³é‡è®¾ç½® */
        .settings-box { width: 600px; background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .setting-row { display: flex; align-items: center; margin-bottom: 15px; }
        .setting-label { width: 80px; font-weight: bold; color: #555; }
        .setting-slider { flex-grow: 1; cursor: pointer; accent-color: var(--sana-deep); }

        /* ç« èŠ‚é€‰æ‹© */
        .chapter-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 800px; }
        .chapter-card {
            background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 20px;
            text-align: center; transition: 0.3s; cursor: pointer; height: 120px; display: flex; flex-direction: column; justify-content: center;
        }
        .chapter-card:hover:not(.locked) { transform: scale(1.05); background: var(--sana-main); border-color: var(--sana-deep); }
        .chapter-card.locked { background: #eee; color: #999; cursor: not-allowed; opacity: 0.7; }
        .ch-num { font-size: 14px; color: #999; margin-bottom: 5px; }
        .ch-title { font-size: 18px; font-weight: bold; color: #333; }

        /* é˜…è§ˆå®¤ (å°è¯´æ¨¡å¼) */
        .library-container { width: 800px; height: 70%; overflow-y: auto; background: #fff; padding: 40px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); font-family: "Songti SC", serif; line-height: 1.8; font-size: 18px; color: #333; text-align: left; }
        .lib-p { margin-bottom: 1em; text-indent: 2em; }
        .lib-name { font-weight: bold; color: var(--sana-deep); margin-right: 5px; }
        .lib-divider { text-align: center; color: #ccc; margin: 30px 0; letter-spacing: 5px; }
        .lib-branch-btn { 
            display: block; margin: 20px auto; padding: 10px 30px; 
            background: #fff; border: 2px dashed var(--sana-deep); color: var(--sana-deep); 
            border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.3s; text-align: center; text-indent: 0;
        }
        .lib-branch-btn:hover { background: var(--sana-main); transform: scale(1.02); }
        .lib-locked { color: #999; border-color: #ccc; cursor: not-allowed; }
/* --- é˜…è§ˆå®¤ç« èŠ‚æ ·å¼ --- */
.lib-chapter-box {
    margin-bottom: 40px;
    padding-bottom: 20px;
    border-bottom: 1px dashed #eee;
}
.lib-chapter-title {
    font-size: 24px;
    font-weight: bold;
    color: var(--sana-deep);
    margin: 20px 0 15px 0;
    padding-left: 10px;
    border-left: 4px solid var(--mina-main);
    background: linear-gradient(to right, #f9f9f9, transparent);
}

  /* === æ–°å¢ï¼šé˜…è§ˆå®¤æ ‡ç­¾é¡µæ ·å¼ === */
.lib-tabs {
    display: flex;
    border-bottom: 2px solid #eee;
    margin-bottom: 20px;
}
.lib-tab {
    padding: 10px 25px;
    cursor: pointer;
    color: #999;
    font-weight: bold;
    border-bottom: 3px solid transparent;
    transition: 0.3s;
    font-size: 18px;
}
.lib-tab:hover { color: var(--sana-deep); }
.lib-tab.active {
    color: var(--sana-deep);
    border-bottom-color: var(--sana-deep);
}
.lib-content-area {
    min-height: 400px;
    /* ç§»é™¤åŸæ¥çš„æœ€å¤§é«˜åº¦é™åˆ¶ï¼Œæ”¹ç”±å¤–å±‚å®¹å™¨æ§åˆ¶ */
}
      
        /* æ¨¡æ€æ¡† (ç”¨äºæ˜¾ç¤ºåˆ†æ”¯å†…å®¹) */
        .modal-popup {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 700px; max-height: 80vh; background: #fff; padding: 30px; z-index: 500;
            box-shadow: 0 0 100px rgba(0,0,0,0.5); border-radius: 10px; overflow-y: auto;
            display: none; font-family: "Songti SC", serif; line-height: 1.8;
        }
        .modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: 499; display: none; }

        /* å†å²è®°å½• */
        .history-list { width: 80%; height: 70%; overflow-y: auto; margin-bottom: 20px; padding: 20px; background: #f9f9f9; border-radius: 10px; border: 1px solid #eee; }
        .log-item { margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        .log-name { color: var(--sana-deep); font-weight: bold; font-size: 14px; margin-bottom: 4px; }

        /* çŠ¶æ€æ  */
        .stats-box { width: 500px; background: #fff; padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .stat-row { display: flex; align-items: center; margin-bottom: 20px; }
        .stat-label { width: 80px; font-weight: bold; color: #555; }
        .stat-track { flex-grow: 1; height: 10px; background: #f0f0f0; border-radius: 5px; overflow: hidden; margin: 0 15px; }
        .stat-fill { height: 100%; transition: width 0.5s ease; }

        /* é€‰é¡¹ */
        #choice-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: none;
            flex-direction: column; justify-content: center; align-items: center; gap: 20px;
            backdrop-filter: blur(4px);
        }
        .choice-btn {
            width: 600px; padding: 20px; background: #fff; border-radius: 10px;
            font-size: 18px; color: #333; cursor: pointer; transition: 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; font-weight: bold;
        }
        .choice-btn:hover { transform: scale(1.02); background: var(--sana-main); color: var(--sana-deep); }

        /* --- 6. æ ‡é¢˜ç”»é¢ --- */
        #title-screen {
            position: absolute; inset: 0; z-index: 200; 
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .title-text { font-size: 72px; font-weight: 300; margin-bottom: 10px; letter-spacing: 10px; color: #333; }
        .title-text span { color: var(--sana-deep); font-weight: bold; border-bottom: 5px solid var(--sana-main); }
        .btn-container { display: flex; flex-direction: column; gap: 10px; margin-top: 30px; width: 300px; }
        .title-btn {
            padding: 12px; font-size: 16px; background: transparent; color: #333; border: 1px solid #ccc;
            border-radius: 30px; cursor: pointer; transition: 0.3s; text-align: center;
        }
        .title-btn:hover { background: var(--sana-main); border-color: var(--sana-deep); color: var(--sana-deep); transform: scale(1.02); }
        .start-btn { background: #333; color: #fff; border: none; font-size: 18px; padding: 15px; }
        .start-btn:hover { background: var(--sana-deep); color: #fff; }

    </style>
</head>

<body>

<div id="game-container">
    <div class="bg-layer"></div>
    <div class="vignette"></div>
    
    <div id="skip-indicator">â­ å¿«è¿›ä¸­...</div>

    <div class="top-bar">
        <button class="sys-btn" onclick="event.stopPropagation(); showStats()">çŠ¶æ€</button>
        <button class="sys-btn" onclick="event.stopPropagation(); showHistory()">è®°å½•</button>
        <button class="sys-btn" onclick="event.stopPropagation(); openGameMenu()">èœå•</button>
    </div>

    <div id="nvl-layer">
        <div id="nvl-content" class="nvl-text"></div>
        <span id="nvl-cursor" class="cursor"></span>
    </div>

    <div class="sprite-layer">
        <div id="char-sana" class="char-img"></div>
        <div id="char-mina" class="char-img"></div>
    </div>
    
    <div id="adv-box">
        <div id="name-box"></div>
        <div id="text-box"></div>
        <span id="adv-cursor" class="cursor"></span>
    </div>

    <div id="choice-overlay" onclick="event.stopPropagation()"></div>

    <div id="title-screen">
        <div class="title-text">è·³ä¸‹æ¥<span>å§</span></div>
        <div style="color:#888; letter-spacing: 2px; margin-bottom:20px;">â€”â€” å‡‘å´çº±å¤&åäº•å— â€”â€”</div>
        
        <div class="btn-container">
            <button class="title-btn start-btn" onclick="event.stopPropagation(); startGame()">å¼€å§‹ç‰©è¯­</button>
            <button class="title-btn" onclick="event.stopPropagation(); openSaveMenu('load')">è¯»å–è¿›åº¦</button>
            <button class="title-btn" onclick="event.stopPropagation(); openChapters()">ç« èŠ‚é€‰æ‹©</button>
            <button class="title-btn" onclick="event.stopPropagation(); openLibrary()">é˜…è§ˆå®¤</button>
        </div>
    </div>

    <div id="menu-overlay" class="overlay-screen" onclick="event.stopPropagation()">
        <div id="menu-title" class="overlay-title">ç³»ç»Ÿèœå•</div>
        
        <div class="settings-box">
            <div class="setting-row">
                <span class="setting-label">BGM éŸ³é‡</span>
                <input type="range" min="0" max="1" step="0.1" value="0.5" class="setting-slider" oninput="setVolume('bgm', this.value)">
            </div>
            <div class="setting-row">
                <span class="setting-label">éŸ³æ•ˆéŸ³é‡</span>
                <input type="range" min="0" max="1" step="0.1" value="0.8" class="setting-slider" oninput="setVolume('sfx', this.value)">
            </div>
        </div>

        <div class="save-slots" id="slots-container"></div>
        <button class="close-btn" onclick="closeMenu()">è¿”å›æ¸¸æˆ</button>
        <button class="title-btn" style="margin-top:10px; border:none; color:#999;" onclick="quitTitle()">å›åˆ°æ ‡é¢˜</button>
    </div>

    <div id="chapter-overlay" class="overlay-screen" onclick="event.stopPropagation()">
        <div class="overlay-title">ç« èŠ‚é€‰æ‹©</div>
        <div class="chapter-grid">
            <div class="chapter-card" onclick="startChapter('ch1_start')">
                <div class="ch-num">CHAPTER 01</div>
                <div class="ch-title">åä¸ƒå²çš„æ˜¥å¤©</div>
            </div>
            <div class="chapter-card locked"><div class="ch-num">CHAPTER 02</div><div class="ch-title">æœªè§£é”</div></div>
            <div class="chapter-card locked"><div class="ch-num">CHAPTER 03</div><div class="ch-title">æœªè§£é”</div></div>
            <div class="chapter-card locked"><div class="ch-num">CHAPTER 04</div><div class="ch-title">æœªè§£é”</div></div>
            <div class="chapter-card locked"><div class="ch-num">CHAPTER 05</div><div class="ch-title">æœªè§£é”</div></div>
            <div class="chapter-card locked"><div class="ch-num">CHAPTER 06</div><div class="ch-title">æœªè§£é”</div></div>
        </div>
        <button class="close-btn" onclick="document.getElementById('chapter-overlay').style.display='none'">å…³é—­</button>
    </div>

    <div id="library-overlay" class="overlay-screen" onclick="event.stopPropagation()">
        <div class="overlay-title">å‰§æƒ…é˜…è§ˆ</div>
        <div style="margin-bottom:10px; color:#999; font-size:14px;">å‘ä¸‹æ»šåŠ¨æŸ¥çœ‹å·²è§£é”å‰§æƒ…</div>
        <div class="library-container" id="library-content">
            </div>
        <button class="close-btn" onclick="document.getElementById('library-overlay').style.display='none'">å…³é—­</button>
    </div>

    <div id="branch-modal-overlay" class="modal-overlay" onclick="closeBranchModal()"></div>
    <div id="branch-modal" class="modal-popup">
        <div style="text-align:right; margin-bottom:10px;"><button onclick="closeBranchModal()" style="border:none;background:none;font-size:24px;cursor:pointer;">Ã—</button></div>
        <div id="branch-content"></div>
    </div>

    <div id="history-overlay" class="overlay-screen" onclick="event.stopPropagation()">
        <div class="overlay-title">å‰§æƒ…å›æº¯</div>
        <div class="history-list" id="history-list"></div>
        <button class="close-btn" onclick="document.getElementById('history-overlay').style.display='none'">å…³é—­</button>
    </div>

    <div id="stats-overlay" class="overlay-screen" onclick="event.stopPropagation()">
        <div class="stats-box">
            <div class="overlay-title" style="text-align:center;">å½“å‰çŠ¶æ€</div>
            <div class="stat-row"><span class="stat-label">ğŸ’– å¿ƒåŠ¨</span><div class="stat-track"><div class="stat-fill" id="bar-love" style="background:var(--sana-deep);"></div></div><span id="val-love" style="color:var(--sana-deep); font-weight:bold;">0</span></div>
            <div class="stat-row"><span class="stat-label">ğŸ”¥ æ¬²æœ›</span><div class="stat-track"><div class="stat-fill" id="bar-lust" style="background:#ff6b81;"></div></div><span id="val-lust" style="color:#ff6b81; font-weight:bold;">0</span></div>
            <div class="stat-row"><span class="stat-label">ğŸ“¡ åŒæ­¥</span><div class="stat-track"><div class="stat-fill" id="bar-sync" style="background:var(--mina-deep);"></div></div><span id="val-sync" style="color:var(--mina-deep); font-weight:bold;">0</span></div>
            <div style="text-align:center; margin-top:30px;"><button class="close-btn" onclick="document.getElementById('stats-overlay').style.display='none'">å…³é—­</button></div>
        </div>
    </div>

</div>

<script>

/* =========================================
       1. å…¨å±€é…ç½® & ç³»ç»Ÿæ•°æ® (æœ€ç»ˆå¢å¼ºç‰ˆ)
       ========================================= */
    
    // å…¨å±€é…ç½®
    let systemConfig = { bgmVolume: 0.5, sfxVolume: 0.8 };

    // ã€å…¨å±€è¿›åº¦ã€‘æ°¸ä¹…ä¿å­˜çš„æ•°æ®ï¼šè§£é”çš„ç»“å±€ã€è¯»è¿‡çš„è¡Œå·
    // *æ³¨æ„*ï¼šè¿™ä¸ªå˜é‡åœ¨ startGame æ—¶ä¸ä¼šè¢«æ¸…ç©º
    let gameProgress = { 
        unlockedEndings: [], 
        readLines: [] 
    };

    // ã€ä¸´æ—¶çŠ¶æ€ã€‘å•æ¬¡æ¸¸æˆçš„æ•°æ®ï¼šå½“å‰ç¬¬å‡ è¡Œã€å¥½æ„Ÿåº¦ã€èƒŒæ™¯å›¾
    // æ¯æ¬¡ startGame éƒ½ä¼šä»è¿™é‡Œæ‹·è´ä¸€ä»½æ–°çš„
    const initialGameState = { 
        idx: 0, 
        stats: { love: 10, lust: 10, sync: 0 },
        logs: [],
        currentBg: "#333", 
        currentBgm: "",     
        currentShow: []
    };

    // å®é™…è¿è¡Œæ—¶çš„æ¸¸æˆçŠ¶æ€
    let gameState = JSON.parse(JSON.stringify(initialGameState));

function loadSystemData() {
        try {
            const config = localStorage.getItem('sana_system_config');
            if (config) systemConfig = JSON.parse(config);
            
            const progress = localStorage.getItem('sana_game_progress');
            if (progress) {
                let temp = JSON.parse(progress);
                // å…¼å®¹æ—§å­˜æ¡£é€»è¾‘
                if (temp.maxIdx !== undefined && (!temp.readLines || temp.readLines.length === 0)) {
                    temp.readLines = [];
                    for(let i=0; i<=temp.maxIdx; i++) temp.readLines.push(i);
                }
                gameProgress = temp;
            }
            // é˜²æŠ¥é”™åˆå§‹åŒ–
            if (!gameProgress.readLines) gameProgress.readLines = [];
            if (!gameProgress.unlockedEndings) gameProgress.unlockedEndings = [];
            
            // ã€æ–°å¢ã€‘åˆå§‹åŒ–è§£é”ç« èŠ‚åˆ—è¡¨ï¼Œé»˜è®¤åªæœ‰ç¬¬1ç« 
            if (!gameProgress.unlockedChapters) gameProgress.unlockedChapters = [1];
            
        } catch (e) {
            console.warn("è¯»å–å­˜æ¡£å¤±è´¥ï¼šå¯èƒ½æ˜¯æœ¬åœ°æ–‡ä»¶æƒé™é—®é¢˜ã€‚", e);
        }

        // æ¢å¤éŸ³é‡
        const bgmInput = document.querySelector("input[oninput*='bgm']");
        if(bgmInput) bgmInput.value = systemConfig.bgmVolume;
        if(audioSystem.bgm) audioSystem.bgm.volume = systemConfig.bgmVolume;

        const sfxInput = document.querySelector("input[oninput*='sfx']");
        if(sfxInput) sfxInput.value = systemConfig.sfxVolume;
}

    function saveSystemData() {
        try {
            localStorage.setItem('sana_system_config', JSON.stringify(systemConfig));
            localStorage.setItem('sana_game_progress', JSON.stringify(gameProgress));
        } catch (e) { console.error("æ— æ³•ä¿å­˜", e); }
    }
// === ã€ä¿®å¤ã€‘éŸ³é‡æ§åˆ¶å‡½æ•° ===
   
 function setVolume(type, value) {
        const val = parseFloat(value);
        
        if (type === 'bgm') {
            systemConfig.bgmVolume = val;
            // å®æ—¶è°ƒæ•´å½“å‰æ­£åœ¨æ’­æ”¾çš„ BGM éŸ³é‡
            if (audioSystem.bgm) {
                audioSystem.bgm.volume = val;
            }
        } else if (type === 'sfx') {
            systemConfig.sfxVolume = val;
            // å®æ—¶è°ƒæ•´å½“å‰æ­£åœ¨æ’­æ”¾çš„éŸ³æ•ˆï¼ˆå¦‚æœæœ‰ï¼‰
            if (audioSystem.currentSfx) {
                audioSystem.currentSfx.volume = val;
            }
        }
        
        // è®°å¾—ä¿å­˜è®¾ç½®ï¼Œè¿™æ ·åˆ·æ–°é¡µé¢åéŸ³é‡è®¾ç½®è¿˜åœ¨
        saveSystemData();
    }


    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è§£é”ç»“å±€çš„è¾…åŠ©å‡½æ•°
    function unlockEnding(id) {
        if (!gameProgress.unlockedEndings.includes(id)) {
            gameProgress.unlockedEndings.push(id);
            saveSystemData(); // ç«‹åˆ»å­˜ç›˜
            alert("âœ¨ æ–°ç»“å±€å·²è§£é”ï¼Œå·²æ”¶å½•è‡³é˜…è§ˆå®¤ï¼");
        }
    }

    // ã€å…³é”®ä¿®æ”¹ã€‘å¼€å§‹æ¸¸æˆ
    function startGame() {
        // 1. åªé‡ç½®ã€å•æ¬¡æ¸¸æˆçŠ¶æ€ã€‘
        gameState = JSON.parse(JSON.stringify(initialGameState));
        
        // 2. ç•Œé¢å½’ä½
        document.getElementById('nvl-layer').style.display = 'none';
        document.getElementById('adv-box').style.opacity = '1';
        document.getElementById('history-list').innerHTML = "";
        document.getElementById('title-screen').style.display = 'none';
   // ã€å»ºè®®å¢åŠ ã€‘å¦‚æœå¼€å§‹æ–°æ¸¸æˆï¼Œä¸éœ€è¦é‡ç½®å…¨å±€å·²è¯»è®°å½•ï¼Œ
        // ä½†ä¸ºäº†é˜²æ­¢é€»è¾‘å†²çªï¼Œå¯ä»¥ç¡®ä¿å½“å‰ idx æ˜¯å‡†ç¡®çš„ 0
        gameState.idx = 0;     

        // 3. å¼€å§‹æ¸²æŸ“ç¬¬ä¸€å¥
        renderScene();
        
        // æ³¨æ„ï¼šè¿™é‡Œç»å¯¹æ²¡æœ‰é‡ç½® gameProgressï¼Œæ‰€ä»¥ä½ çš„é˜…è§ˆå®¤è®°å½•æ˜¯å®‰å…¨çš„
    }

// === ã€ä¿®å¤ã€‘æ–°å¢ï¼šç« èŠ‚è·³è½¬ä¸“ç”¨å‡½æ•° ===

function startChapter(label) {
    // 1. å…³é—­ç« èŠ‚é€‰æ‹©çª—å£
    document.getElementById('chapter-overlay').style.display = 'none';

    // 2. é‡ç½®æ¸¸æˆçŠ¶æ€ (å’Œ startGame é€»è¾‘ç±»ä¼¼ï¼Œä½†éœ€è¦æŒ‡å®šä½ç½®)
    gameState = JSON.parse(JSON.stringify(initialGameState));
    
    // 3. ç•Œé¢å½’ä½
    document.getElementById('nvl-layer').style.display = 'none';
    document.getElementById('adv-box').style.opacity = '1';
    document.getElementById('history-list').innerHTML = "";
    document.getElementById('title-screen').style.display = 'none';

    // 4. å¯»æ‰¾è·³è½¬ç›®æ ‡
    // è¿™ä¸€æ­¥éå¸¸å…³é”®ï¼šå®ƒä¼šåœ¨å‰§æœ¬æ•°ç»„é‡Œæ‰¾ label å¯¹åº”çš„ä½ç½®
    const targetIdx = script.findIndex(item => item.label === label);
    
    if (targetIdx !== -1) {
        gameState.idx = targetIdx;
        renderScene(); // å¼€å§‹æ¸²æŸ“è¯¥ç« èŠ‚
    } else {
        console.error("é”™è¯¯ï¼šæ‰¾ä¸åˆ°ç« èŠ‚æ ‡ç­¾ " + label);
        alert("ç« èŠ‚è·³è½¬å¤±è´¥ï¼šæ‰¾ä¸åˆ°æ ‡ç­¾ " + label);
    }
}
    /* =========================================
       2. æ¸¸æˆå‰§æœ¬
       ========================================= */
    const script = [
        // ã€æ ‡è®°ã€‘ç¬¬ä¸€ç« å¼€å§‹
        { label: "ch1_start", mode: "adv", name: "å‡‘å´çº±å¤", text: "å¥½æ— èŠâ€¦â€¦", bg: "sanaroom.jpg", show: ["sana"], focus: "sana", bgm: "bgm_daily.mp3" },
        
        { mode: "nvl", text: "å‡‘å´çº±å¤åŠèººåœ¨åºŠä¸Šï¼Œè„šå°–æœ‰ä¸€ä¸‹æ²¡ä¸€ä¸‹åœ°è½»è¸¢ç€åºŠæ²¿ï¼Œåƒæ˜¯é ç€å¾®å°çš„å£°å“æ‰“å‘æ— èŠçš„æ—¶é—´ã€‚" },
        { mode: "nvl", text: "çª—å¤–æ˜¯ä¹…è¿çš„é˜´å¤©ï¼Œç©ºæ°”ä¹Ÿå˜å¾—æ¹¿æ¶¦è€Œä¸å†è®©äººè§‰å¾—ç‡¥çƒ­ã€‚å¥¹è½¬è¿‡å¤´çœ‹å‘çª—æˆ·ï¼Œé€è¿‡é‚£æ‰‡æ—¶å¸¸è¢«å¥¹æ‰”çº¸å›¢æ•²æ‰“çš„ç»ç’ƒï¼Œèƒ½éšçº¦çœ‹åˆ°åäº•å—å®¶äºŒæ¥¼ç´§é—­çš„çª—å¸˜ã€‚", bg: "windows.jpg" },
        { mode: "nvl", text: "â€¦â€¦å—ã€‚" },        
        { mode: "nvl", text: "ä¸çŸ¥é“å—åœ¨åšä»€ä¹ˆï¼Ÿå‡‘å´çº±å¤å¿ƒä¸åœ¨ç„‰åœ°å’¬ç€è‡ªå·±çš„ä¸‹å”‡å‡ºç¥ã€‚å¥¹å’Œåäº•å—ä»å…­å²èµ·å°±æˆäº†é‚»å±…ï¼Œåå¹´è¿‡å»ï¼Œå¥¹å´æ€»è§‰å¾—è‡ªå·±å’Œé‚£ä¸ªå®‰é™å†…æ•›çš„å¥³å­©ä¹‹é—´éš”ç€ä¸€å±‚éš¾ä»¥è§¦ç¢°çš„è–„è†œã€‚" },
        { mode: "nvl", text: "è¯´æ˜¯é’æ¢…ç«¹é©¬ï¼Œä½†åäº•å—çš„çœ¼ç›ä»æœªçœŸæ­£åœ°å¯¹ä¸Šè¿‡å¥¹çš„è§†çº¿è¶…è¿‡äº”ç§’é’Ÿã€‚" },
        
        { 
            mode: "adv", type: "choice", 
            options: [
                { text: "ç»§ç»­ç›¯ç€é‚£æ‰‡çª—æˆ·ï¼Œè¯•å›¾çœ‹ç©¿é‚£å±‚çª—å¸˜", next: "look_window", effect: { love: 2 } },
                { text: "å¹äº†å£æ°”ï¼Œè§‰å¾—æ— èŠï¼Œç¿»èº«æ‹¿èµ·æ‰‹æœº", next: "check_phone", effect: { lust: 2 } } 
            ] 
        },

        // === é€‰é¡¹ A è·¯çº¿ ===
        { label: "look_window", mode: "nvl", text: "å‡‘å´çº±å¤ç»§ç»­ç›¯ç€é‚£æ‰‡çª—æˆ·ï¼Œè¯•å›¾çœ‹ç©¿é‚£å±‚è–„è†œã€‚å³ä¾¿ä»€ä¹ˆéƒ½çœ‹ä¸è§ï¼Œä¹Ÿæƒ³é€è¿‡å¸ƒæ–™çœ‹åˆ°é‡Œé¢çš„äººã€‚" },
        { jump: "scene_out" },

        // === é€‰é¡¹ B è·¯çº¿ ===
        { label: "check_phone", mode: "nvl", text: "å‡‘å´çº±å¤å¹äº†å£æ°”ï¼Œç¿»äº†ä¸ªèº«è®©æ‰‹æœºå±å¹•æœä¸Šèººåœ¨åºŠä¸Šã€‚è§£é”ç•Œé¢è·³å‡ºæ¥ï¼Œæ˜¯ä¸€å¼ å¾®å¾®æ³›ç€ç²‰è‰²çš„ç…§ç‰‡ã€‚", bg: "sanaroom.jpg" },
        { bg: "phone.jpg" },
        { mode: "nvl", text: "ç…§ç‰‡é‡Œçš„å¥³å­©ç©¿ç€çŸ­çŸ­çš„ç™½è‰²Tæ¤ï¼Œä¸‹åŠæˆªçš„è…°èº«çº¤ç»†ç™½çš™ï¼Œä¸‰è§’å¼æ³³è£…ä»ç‰›ä»”è£¤çš„ä¸Šè¾¹ç¼˜éœ²å‡ºï¼Œå¸¦ç€ä¸€ç‰‡ç»†å«©çš„çš®è‚‰ï¼Œè£¤è…°å› ä¸ºç…§ç‰‡ä¸»äººç˜¦å‰Šçš„èº«å½¢æ¾æ¾å®å®ï¼Œä¼¼ä¹éšæ—¶ä¼šå› ä¸ºä¸€ä¸ªåŠ¨ä½œè€Œæ»‘è½ã€‚" },
        { mode: "nvl", text: "ç…§ç‰‡åªæ‹åˆ°äº†é”éª¨åˆ°å¤§è…¿çš„éƒ¨åˆ†ï¼Œçœ‹ä¸åˆ°è„¸ï¼Œå´è«åè®©äººè§‰å¾—æƒ…è‰²ã€‚è¿™å¼ ç…§ç‰‡æ˜¯å¥¹åœ¨æŸä¸ªåŒ¿åè´¦å·ä¸Šå¶ç„¶åˆ·åˆ°çš„ï¼Œå¥¹é¬¼ä½¿ç¥å·®åœ°è®¾æˆäº†å£çº¸ï¼Œæ¯æ¬¡è§£é”æ‰‹æœºéƒ½å°å¿ƒç¿¼ç¿¼ã€‚" },
        { mode: "adv", name: "å‡‘å´çº±å¤", text: "æˆ‘â€¦â€¦æ˜¯åœ¨åšä»€ä¹ˆä¸è¯¥åšçš„äº‹æƒ…å—ï¼Ÿ", show: ["sana"], focus: "sana" },
        { mode: "nvl", text: "å‡‘å´çº±å¤æ„Ÿåˆ°æœ‰äº›ç¾æ„§ï¼Œä½†ç›´åˆ°ç°åœ¨ï¼Œå¥¹ä¹Ÿæ²¡æœ‰æ¢ä¸‹è¿™å¼ ç…§ç‰‡ã€‚" },
        { mode: "nvl", text: "å¥¹ä¸è®°å¾—è‡ªå·±æ˜¯ä»€ä¹ˆæ—¶å€™å¼€å§‹çœ‹é‚£ä¸ªè´¦å·çš„äº†ã€‚èµ·åˆåªæ˜¯è§‰å¾—ç…§ç‰‡æ„å›¾å¾ˆæ¼‚äº®ï¼Œè¡£ç‰©çš„è¤¶çš±ã€å…‰å½±çš„äº¤é”™éƒ½æ°åˆ°å¥½å¤„ï¼Œåæ¥å´å‘ç°è‡ªå·±å¼€å§‹åœ¨æ„èµ·é‚£ä¸ªä¸éœ²è„¸çš„å¥³å­©ã€‚" },
        { mode: "nvl", text: "ä»è½®å»“å’Œè‚¢ä½“è¯­è¨€æ¥çœ‹ï¼Œé‚£ä¸ªå¥³å­©å¾ˆå¹´è½»ï¼Œä¹Ÿè®¸å’Œå¥¹ä¸€æ ·æ˜¯é«˜ä¸­ç”Ÿï¼Œç»†ç˜¦çš„æ‰‹è…•å’Œè…°çº¿æœ‰ç€å°‘å¥³ç‰¹æœ‰çš„æŸ”è½¯ä¸é’æ¶©ã€‚" },
        
        {
            mode: "adv", type: "choice",
            options: [
                { text: "ä¹Ÿè®¸æ˜¯æŸä¸ªé™Œç”Ÿçš„ç½‘ç»œçº¢äººå§", next: "think_stranger", effect: { lust: 2 } },
                { text: "â€œå—ä¼šæ‹è¿™ç§ç…§ç‰‡å—ï¼Ÿâ€", next: "think_mina", effect: { love: 3, lust: 3, sync: 2 } } 
            ]
        },

        { label: "think_stranger", mode: "nvl", text: "ä¹Ÿè®¸æ˜¯æŸä¸ªé™Œç”Ÿçš„ç½‘ç»œçº¢äººå§ã€‚å‡‘å´çº±å¤è¿™æ ·æƒ³ç€ï¼Œå¿ƒä¸åœ¨ç„‰åœ°åˆ’è¿‡å±å¹•ã€‚" },
        { jump: "scene_out" },

        { label: "think_mina", mode: "nvl", text: "â€œå—ä¼šæ‹è¿™ç§ç…§ç‰‡å—ï¼Ÿâ€è¿™ä¸ªçªå¦‚å…¶æ¥çš„æƒ³æ³•è®©å‡‘å´çº±å¤æ„£äº†ä¸€ä¸‹ï¼Œéšå³åˆå—¤ç¬‘å‡ºå£°ã€‚" },
        { mode: "nvl", text: "åäº•å—é‚£æ ·çš„ä¹–ä¹–å¥³ï¼Œå®¶é‡Œäººåƒæ‹§ç´§å‘æ¡ä¸€æ ·æŠŠå¥¹æ¡†åœ¨è§„æ•´çš„è½¨é“ä¸Šï¼Œæ€ä¹ˆå¯èƒ½ä¼šåšè¿™ç§äº‹æƒ…ï¼Ÿ" },
        { mode: "nvl", text: "å¯å‡‘å´åˆå¿ä¸ä½æƒ³è±¡ï¼Œå¦‚æœé‚£ä¸ªæ€»æ˜¯å¾®å¾®è¹™ç€çœ‰å¤´çš„å¥³å­©ï¼Œç©¿ç€æ€§æ„Ÿçš„æ³³è¡£ï¼Œåœ¨æ‹ç…§æ—¶åˆ»æ„åœ°éœ²å‡ºè„†å¼±çº¤ç»†çš„è…°è‚¢ï¼Œä¼šæ˜¯ä»€ä¹ˆæ ·å­ã€‚" },

        // === å‡ºé—¨åœºæ™¯ ===
        { label: "scene_out", mode: "nvl", text: "ã€â™ª æ¶ˆæ¯æç¤ºéŸ³ã€‘", sfx: "sfx_notify.mp3" },
        { mode: "nvl", text: "å¥¹çš„æ€ç»ªè¢«æç¤ºéŸ³æ‰“æ–­ï¼Œæ‰‹æœºå±å¹•äº®èµ·ï¼Œå£çº¸ä¸Šçš„å¥³å­©çŸ­æš‚åœ°å‡ºç°åˆéšæ²¡åœ¨è§£é”ç•Œé¢ã€‚æ˜¯åŒç­å‡ ä¸ªåµåµé—¹é—¹çš„æœ‹å‹é—®å¥¹è¦ä¸è¦ä¸€èµ·å»æ–°å¼€çš„æ¸¸æˆå…ã€‚" },
        { mode: "nvl", text: "å‡‘å´çº±å¤çŠ¹è±«äº†ä¸€ä¸‹ï¼Œå‘äº†ä¸ªâ€œå¥½â€å­—è¿‡å»ã€‚" },
        { mode: "nvl", text: "å¥¹ä»åºŠä¸Šä¸€è·ƒè€Œèµ·ï¼Œç«™åœ¨é•œå­å‰æ•´ç†äº†ä¸€ä¸‹å¤´å‘ï¼Œç›®å…‰ä»é•œå­çš„è§’è½é‡Œç¥å‘çª—å¤–â€”â€”åäº•å—çš„çª—å¸˜ä¾ç„¶ç´§é—­ã€‚", bg: "windows.jpg" },
        { mode: "adv", name: "å‡‘å´çº±å¤", text: " è¦è¯•ä¸€ä¸‹å«ä¸Šå—å—ï¼Ÿ", show: ["sana"], focus: "sana" },

        {
            mode: "adv", type: "choice",
            options: [
                { text: "å°è¯•å‘æ¶ˆæ¯ï¼šâ€œè¦ä¸è¦ä¸€èµ·å»ï¼Ÿâ€", next: "invite_mina", effect: { love: -1 } }, 
                { text: "æ‘‡æ‘‡å¤´ï¼Œç®—äº†", next: "give_up_invite", effect: { sync: -1 } } 
            ]
        },

        { label: "invite_mina", mode: "nvl", text: "ä¹Ÿè®¸åº”è¯¥é‚€è¯·å—ä¸€èµ·å»ï¼Ÿå‡‘å´è¿™æ ·æƒ³ç€ï¼Œåˆæƒ³èµ·äº†ä¸Šæ¬¡å¥¹è¿™ä¹ˆåšçš„æ—¶å€™ï¼Œå—ç”¨é‚£ç§å¤æ‚çš„çœ¼ç¥çœ‹ç€å¥¹ï¼Œåƒæ˜¯å‘å¾€åˆåƒæ˜¯è®¨åŒï¼Œæœ€ååªæ˜¯ç¤¼è²Œåœ°è¯´äº†å¥â€œè°¢è°¢ï¼Œä½†æˆ‘è¦å†™ä½œä¸šâ€ã€‚" },
        { jump: "library_memory" },

        { label: "give_up_invite", mode: "nvl", text: "ç®—äº†ã€‚å‡‘å´çº±å¤å¹äº†å£æ°”ï¼Œä¸Šæ¬¡å¥¹è¿™ä¹ˆåšçš„æ—¶å€™ï¼Œå—ç”¨é‚£ç§å¤æ‚çš„çœ¼ç¥çœ‹ç€å¥¹ï¼Œåƒæ˜¯å‘å¾€åˆåƒæ˜¯è®¨åŒï¼Œæœ€ååªæ˜¯ç¤¼è²Œåœ°è¯´äº†å¥â€œè°¢è°¢ï¼Œä½†æˆ‘è¦å†™ä½œä¸šâ€ã€‚" },

        // === å›¾ä¹¦é¦†å›å¿† ===
        { label: "library_memory", mode: "nvl", text: "å¥¹æ‰“å¼€è¡£æŸœæ¢ä¸Šä¸€ä»¶Tæ¤ï¼Œè§†çº¿ä¸ç»æ„é—´æ è¿‡é å¢™çš„ä¹¦æ¡Œï¼Œé‚£é‡Œæ‘Šç€å¥¹å‰å¤©æ‰å€Ÿæ¥è¿˜æ²¡çœ‹çš„ä¹¦ã€‚", bg: "sanaroom.jpg" },
        { mode: "nvl", text: "æƒ³åˆ°è¿™é‡Œï¼Œå‡‘å´çº±å¤å’§å˜´ç¬‘äº†ï¼Œå€Ÿä¹¦åªæ˜¯ä¸ªå€Ÿå£ï¼Œå¥¹åªæ˜¯æƒ³æ‰¾æœºä¼šå’Œåäº•å—è¯´ä¸Šå‡ å¥è¯ã€‚" },
        { mode: "nvl", text: "å›¾ä¹¦é¦†è§’è½é‡Œçš„å—å®‰é™åœ°å‚ç€çœ¼çš®ï¼Œå¤´å‘åœ¨é˜³å…‰ä¸‹æ³›ç€æµ…æµ…çš„å…‰ï¼Œè…°èƒŒæŒºå¾—ç¬”ç›´ï¼Œå‡‘å´çœ‹åˆ°å¥¹æ—¶å±…ç„¶æœ‰ä¸€ç¬é—´çš„ç´§å¼ ã€‚", bg: "library.jpg" },
        { mode: "nvl", text: "æ‰‹æœºæŒ¯åŠ¨èµ·æ¥ï¼Œæœ‹å‹å‚¬å¥¹å¿«ç‚¹ä¸‹æ¥¼ã€‚å‡‘å´çº±å¤æ‹¿èµ·æ‰‹æœºï¼Œé‚£å¼ ç…§ç‰‡åˆåœ¨è§£é”çš„ä¸€ç¬é—´æ™ƒè¿‡çœ¼å‰ï¼Œå¥¹ç›¯ç€çœ‹äº†å‡ ç§’ã€‚", bg: "library.jpg" },

        // åˆ†æ”¯é€‰é¡¹ 1.4
        {
            mode: "adv", type: "choice",
            options: [
                { text: "å…³ä¸Šå±å¹•ï¼Œå‡ºé—¨", next: "bad_end", effect: {} },
                { text: "é¬¼ä½¿ç¥å·®åœ°ï¼Œå¯¹é‚£ä¸ªè´¦å·ç‚¹ä¸‹äº†å…³æ³¨", next: "true_route", effect: { sync: 5, lust: 5 } }
            ]
        },

        // === Bad Ending: è·¯äºº ===
        { label: "bad_end", mode: "nvl", text: "ç®—äº†ï¼Œåªæ˜¯å¶ç„¶åˆ·åˆ°çš„ä¸€ä¸ªè´¦å·è€Œå·²ã€‚å‡‘å´çº±å¤å…³ä¸Šå±å¹•ï¼Œæ‹¿èµ·é’¥åŒ™å†²å‡ºäº†æˆ¿é—¨ã€‚" },
        { mode: "nvl", text: "å¥¹é‚£å¤©ç©åˆ°å¾ˆæ™šæ‰å›å®¶ï¼Œè·¯è¿‡åäº•å—çš„çª—å‰çš„æ—¶å€™ï¼Œä¹ æƒ¯æ€§åœ°æŠ¬å¤´ï¼Œä½†çª—å­å·²ç»æš—ä¸‹å»äº†ã€‚" },
        { mode: "nvl", text: "â€œæƒ³ä¹Ÿæ˜¯è¿™æ ·ã€‚â€å‡‘å´çº±å¤è½»è½»åœ°å¹äº†å£æ°”ï¼Œå¤§æ¦‚å¥¹å’Œå—ç»ˆç©¶æ˜¯æ€§æ ¼ä¸å¤ªåˆï¼Œä»¥åè¿˜æ˜¯å°‘å»æƒ¹å—è®¨åŒæ¯”è¾ƒå¥½ã€‚" },
        { mode: "nvl", text: "ã€Bad Ending: è·¯äººã€‘" },
        { mode: "code", action: () => unlockEnding("bad_end") }, 
        { jump: "title_return" },

        // === True Route å¼€å§‹ (ä¸»çº¿ç»§ç»­) ===
        { label: "true_route", mode: "nvl", text: "é¬¼ä½¿ç¥å·®åœ°ï¼Œå‡‘å´çº±å¤çš„æ‰‹æŒ‡åœ¨å±å¹•ä¸Šç‚¹äº†ä¸€ä¸‹ã€‚" },
        { mode: "adv", name: "ç³»ç»Ÿ", text: "ã€å…³æ³¨æˆåŠŸã€‘" },
        { mode: "nvl", text: "ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œå‡‘å´çº±å¤æ„Ÿåˆ°è‡ªå·±çš„å¿ƒè„çŒ›åœ°è·³äº†ä¸€ä¸‹ã€‚å¥¹æœ‰ç‚¹åšè´¼å¿ƒè™šåœ°å¿«é€Ÿç†„ç­äº†å±å¹•ï¼ŒæŠŠæ‰‹æœºè—è¿›å£è¢‹é‡Œäº†ã€‚" },
        
        { mode: "adv", name: "åäº•å—", text: "ï¼ˆåœä¸‹æ‰‹ä¸­çš„ç¬”ï¼‰â€¦â€¦", bg: "mina1.jpg", show: ["mina"], focus: "mina" },
        { mode: "nvl", text: "åäº•å—è·ªåœ¨ä¹¦æ¡Œå‰ï¼Œæ•´ç†ç€è‡ªå·±çš„æ•°å­¦ä½œä¸šã€‚å…¶å®å¥¹æ—©å°±ä¼šåšäº†ï¼Œé‚£äº›å…¬å¼å’Œè§£é¢˜æ­¥éª¤åœ¨å¥¹è„‘æµ·ä¸­å¦‚è¡Œäº‘æµæ°´èˆ¬æ¸…æ™°ã€‚"},
        { mode: "nvl", text: "å¥¹æ˜¯å¹´çº§ç¬¬ä¸€ï¼Œè¯¾å ‚ä¸Šè€å¸ˆè®²çš„é‚£ä¸€å¥—æµç¨‹å¥¹ä¸‰ä¸¤ä¸‹å°±èƒ½æå®šã€‚ç¬”å°–åœ¨çº¸é¢åˆ’å‡ºçš„å£°å“æ¯ç‡¥è€Œæ— èŠï¼Œå¥¹æ„Ÿåˆ°çƒ¦é—·ï¼Œåœäº†æ‰‹ï¼ŒæŠ¬å¤´æœ›å‘çª—å¤–ã€‚", bg: "minaroom.jpg" },
        { mode: "nvl", text: "äºŒæ¥¼ä¸ç®—é«˜ï¼Œè¶³å¤Ÿçœ‹æ¸…æ¥¼ä¸‹é‚£ä¸ªæ¯å¤©å‚æ™šéƒ½è¦è·¯è¿‡çš„èº«å½±ã€‚" },
        
        { mode: "nvl", text: "", bg: "sana1.jpg"}, 
        
        { mode: "nvl", text: "å‡‘å´çº±å¤ä»Šå¤©åˆç©¿äº†é‚£ä»¶å®½æ¾çš„æµ…è‰²Tæ¤ï¼Œæ£‰è´¨é¢æ–™å‚å åœ¨å¥¹ç®—ä¸ä¸Šä¸°æ»¡ä½†æ°åˆ°å¥½å¤„çš„èƒ¸å‰ï¼Œä¸‹æ‘†éšæ„åœ°å¡è¿›é«˜è…°çš„ç‰›ä»”çŸ­è£¤é‡Œï¼Œéœ²å‡ºä¿®é•¿è€Œç´§å®çš„æ¼‚äº®å¤§è…¿ã€‚" },
        { mode: "nvl", text: "å¥¹çš„å¤´å‘æŸ“æˆäº†æ —è‰²ï¼Œåœ¨è½æ—¥ä½™æ™–é‡Œæ³›ç€å¾®çº¢çš„å…‰ï¼Œé£å¹è¿‡æ—¶è½»è½»æ‹‚è¿‡å¥¹çº¿æ¡åˆ†æ˜çš„ä¸‹é¢Œã€‚" },
        { mode: "nvl", text: "å—çœ‹ç€å¥¹å’Œèº«è¾¹æ€»æ˜¯ä¸ç¼ºçš„æœ‹å‹ä»¬æœ‰è¯´æœ‰ç¬‘ï¼Œä¸æ—¶çˆ†å‘å‡ºä¸€é˜µå“äº®çš„ç¬‘å£°ï¼Œå¶å°”æ¢å‡ºå¤´æ¥å†²ç€ç´§é—­çš„çª—æˆ·å–Šï¼šâ€œå—ï¼å—ï¼â€" },
        { mode: "nvl", text: "å£°éŸ³é‡Œå¸¦ç€ä¸çŸ¥ä»ä½•è€Œæ¥çš„ä¿¡å¿ƒï¼Œä»¿ä½›ç¡®ä¿¡çª—å†…çš„äººä¸€å®šä¼šå›åº”ã€‚" },
        
        { mode: "adv", name: "åäº•å—", text: "ï¼ˆæŠ¿ç€å˜´å”‡ï¼Œå‡è£…æ²¡å¬è§ï¼‰â€¦â€¦", show: ["mina"], focus: "mina" },
        { mode: "nvl", text: "ä½†å¥¹çš„æ‰‹æŒ‡ä¸è‡ªè§‰åœ°åœ¨ä¹¦é¡µä¸Šç•™ä¸‹äº†ä¸€é“æ·¡æ·¡çš„è¤¶çš±ã€‚" },
        
        { mode: "nvl", text: "å¥¹ä»¬æ˜¯é‚»å±…ï¼Œä¹Ÿæ˜¯é’æ¢…ç«¹é©¬ï¼Œä»å¹¼å„¿å›­å¼€å§‹å°±ååœ¨ç›¸é‚»çš„åº§ä½ä¸Šï¼Œä½†åäº•å—ä»ä¸è§‰å¾—å¥¹ä»¬å¤šäº²è¿‘ã€‚" },
        { mode: "nvl", text: "å‡‘å´çº±å¤æ˜¯åœ¨ç‚çƒ­å¤å¤©è¿èƒŒå¦ˆå¦ˆâ€œä¸è¦è´ªå‡‰â€çš„è¯æºœè¿›ä¾¿åˆ©åº—å·ä¹°å†°æ·‡æ·‹çš„å­©å­ï¼Œç”œç­’èåŒ–å¾—é£å¿«ï¼Œé¡ºç€å¥¹çš„æ‰‹è…•æ»´è½åœ¨åœ°ä¸Šï¼Œç•™ä¸‹ä¸€æ¡ç”œè…»çš„ç—•è¿¹ã€‚å¥¹æ˜¯æ€»èƒ½ç”¨è¹©è„šå€Ÿå£ç³Šå¼„è¿‡ä¸¥å‰è€å¸ˆçš„å°æ¶é­”ã€‚" },
        { mode: "nvl", text: "è€Œåäº•å—æ˜¯ä»ä¸ä¼šåšè¿™äº›äº‹çš„ä¼˜ç­‰ç”Ÿï¼Œæ˜¯åœ¨çˆ¶æ¯ä¸¥å‰ç›®å…‰ä¸‹ä¸€å¯¸ä¸€å¯¸æ‹”èŠ‚æˆé•¿çš„ã€ä¼˜ç§€å¾—æ¯«æ— ç‘•ç–µçš„æ¼‚äº®äººå¶ï¼Œç”Ÿæ€•ä¸€ä¸ªä¸å°å¿ƒï¼Œå°±æŠŠé‚£äº›ç”¨æ•°å¹´æ—¶é—´å°å¿ƒç¿¼ç¿¼æ„å»ºçš„å®Œç¾å½¢è±¡å‡»å¾—ç²‰ç¢ã€‚" },
        
        { mode: "nvl", text: "ã€é—ªå›ï¼šè®°å¿†ç”»é¢ã€‘", bg: "sana2.jpg", bgm: "bgm_memory.mp3" },
        
        { mode: "adv", name: "å‡‘å´çº±å¤", text: "å—ï¼Œæ²¡å…³ç³»ï¼Œè·³ä¸‹æ¥ï¼Œæˆ‘æ¥ä½ä½ ï¼Œä¸ä¼šæœ‰äººéª‚ä½ çš„ï¼", show: ["sana"], focus: "sana" },
        { mode: "nvl", text: "å‡‘å´çº±å¤ç«™åœ¨å¥¹å®¶çª—å°ä¸‹ä»°ç€å¤´å‘ä¸Šå–Šï¼Œé˜³å…‰æŠŠå¥¹çš„å½±å­æ‹‰å¾—å¾ˆé•¿ï¼Œå¥¹ç»†ç˜¦çš„æ‰‹è‡‚å¼ å¼€ï¼Œåƒæ˜¯è¦æ‹¥æŠ±æ•´ä¸ªä¸–ç•Œã€‚" },
        { mode: "nvl", text: "é‚£æ—¶å€™åäº•å—æ­£å› ä¸ºè€ƒè¯•æˆç»©æœªè¾¾æ ‡è€Œè¢«ç¦è¶³ã€‚çˆ¶äº²çš„å£°éŸ³è¿˜åœ¨è€³è¾¹å›å“ï¼Œå¥¹ç–²æƒ«åœ°å‘çª—å¤–æœ›å»ï¼Œçœ‹ç€æ¥¼ä¸‹é‚£ä¸ªç¬‘å˜»å˜»çš„å¥³å­©å¼ å¼€åŒè‡‚ï¼Œå¥¹çœ‹åˆ°å¥¹é—ªé—ªå‘äº®çš„çœ¼ç›ã€‚" },
        { mode: "nvl", text: "çª—å°ä¸‹æ˜¯çˆ¶äº²ç²¾å¿ƒæ‰“ç†çš„èŠ±å›ï¼Œé‡Œé¢ç§ç€ä¸€æ’æ’æ•´é½çš„éƒé‡‘é¦™ï¼Œå¦‚æœçœŸçš„è·³ä¸‹å»ï¼Œå¤§æ¦‚ç‡æ˜¯ä¼šæ‘”æ–­è…¿çš„ã€‚" },
        { mode: "nvl", text: "å¥¹å½“ç„¶æ²¡æœ‰è·³ï¼Œåªæ˜¯é»˜é»˜æ‹‰ä¸Šäº†çª—å¸˜ï¼Œç”¨åŠ›å’¬ç€ä¸‹å”‡ï¼ŒæŠ‘åˆ¶ä½å–‰å’™æ·±å¤„é‚£ä¸ªæƒ³è¦å‘¼å–Šå›åº”çš„å†²åŠ¨ã€‚", bg: "nightsky.jpg" },
        { mode: "nvl", text: "é‚£ä¸ªæ™šä¸Šï¼Œå‡‘å´çº±å¤åœ¨å¥¹å®¶æ¥¼ä¸‹çš„è‰åªä¸Šèººäº†æ•´æ•´ä¸€å¤œï¼Œä»°æœ›ç€æ˜Ÿç©ºï¼Œå¶å°”è½»å£°å“¼å”±ç€ä¸æˆè°ƒçš„æ­Œè°£ã€‚" },
        { mode: "adv", name: "åäº•å—", text: "å°±æ˜¯è¿™æ ·çš„çº±å¤ï¼Œè€Œæˆ‘å¯¹çº±å¤â€¦â€¦åˆæ˜¯æ€€ç€ä»€ä¹ˆæ ·çš„æ„Ÿæƒ…å‘¢ï¼Ÿ", show: ["sana"], focus: "sana" },
        
        {
            mode: "adv", type: "choice",
            options: [
                { text: "æ˜¯å«‰å¦’", next: "feeling_hate", effect: { love: -2, lust: 5 } },
                { text: "æ˜¯ç¾¡æ…•å’Œæ¸´æœ›", next: "feeling_yearn", effect: { love: 5, lust: 5 } } 
            ]
        },

        { label: "feeling_hate", mode: "nvl", text: "ç°åœ¨æƒ³æ¥ï¼Œåäº•å—ä¹Ÿåˆ†ä¸æ¸…è‡ªå·±å¯¹å‡‘å´çº±å¤çš„æ„Ÿæƒ…åˆ°åº•æ˜¯ä»€ä¹ˆã€‚å¯èƒ½æ˜¯å«‰å¦’å¥¹èƒ½ä¸è´¹å¹ç°ä¹‹åŠ›åœ°æ´»åœ¨é˜³å…‰ä¸‹çš„è‡ªç”±ï¼Œå«‰å¦’å¥¹æ€»èƒ½è½»è€Œæ˜“ä¸¾å¾—åˆ°è‡ªå·±æƒ³è¦çš„ä¸€åˆ‡ã€‚", show: ["mina"], focus: "mina" },
        { jump: "mina_secret" },

        { label: "feeling_yearn", mode: "nvl", text: "ç°åœ¨æƒ³æ¥ï¼Œåäº•å—ä¹Ÿåˆ†ä¸æ¸…è‡ªå·±å¯¹å‡‘å´çº±å¤çš„æ„Ÿæƒ…åˆ°åº•æ˜¯ä»€ä¹ˆã€‚æ˜¯ç¾¡æ…•å¥¹èƒ½ä¸è´¹å¹ç°ä¹‹åŠ›åœ°æ´»åœ¨é˜³å…‰ä¸‹çš„è‡ªç”±ï¼Œè¿˜æ˜¯æ¨å¥¹æ€»èƒ½è½»è€Œæ˜“ä¸¾å¾—åˆ°è‡ªå·±æƒ³è¦çš„ä¸€åˆ‡ï¼Ÿ", show: ["mina"], focus: "mina" },
        { mode: "nvl", text: "åˆæˆ–è€…ï¼Œæ˜¯å› ä¸ºæ¯æ¬¡çœ‹åˆ°å¥¹ï¼Œéƒ½ä¼šæé†’è‡ªå·±å†…å¿ƒæ·±å¤„é‚£ä¸ªè¢«å‹æŠ‘å¤ªä¹…çš„ã€æ¸´æœ›æŒ£è„±æŸç¼šçš„è‡ªå·±ï¼Ÿ" },

        // === åäº•å—çš„ç§˜å¯† ===
        { label: "mina_secret", mode: "nvl", text: "åä¸ƒå²é‚£å¹´çš„æ˜¥å¤©ï¼Œåäº•å—çŠ¯äº†é”™ã€‚", bg: "minaroom.jpg" },
        { mode: "nvl", text: "å‡†ç¡®åœ°è¯´ï¼Œæ˜¯ç¬¬ä¸€æ¬¡æœ‰æ„è¯†åœ°è¿èƒŒçˆ¶æ¯çš„æœŸæœ›ï¼Œåšäº†ä¸€ä»¶â€œä¸è¯¥åšâ€çš„äº‹ã€‚" },
        { mode: "nvl", text: "å¥¹å¼€å§‹åœ¨åŒ¿åè´¦å·ä¸Šå‘å¸ƒé‚£äº›çœ‹ä¸åˆ°è„¸çš„ï¼Œå¸¦ç€æš—ç¤ºæ„å‘³çš„ç…§ç‰‡ã€‚ä¸è‡³äºéœ²éª¨ï¼Œä½†è¶³å¤Ÿå¼•äººéæƒ³ï¼Œè¶³å¤Ÿæ‰“ç ´æ‰€æœ‰äººçœ¼ä¸­ä¹–å·§å®‰é™çš„é‚£ä¸ªåäº•å—çš„å½¢è±¡ã€‚" },
        { mode: "nvl", text: "å¥¹è£¹ç€è¢«å•ï¼Œæˆ–è€…ç©¿ç€å®½å¤§çš„è¡¬è¡«ï¼Œæ€»æ˜¯æ°åˆ°å¥½å¤„åœ°éœ²å‡ºä¸€ç‚¹è‚©è†€ï¼Œä¸€æ®µé”éª¨ï¼Œæˆ–æ˜¯èœœæ¡ƒèˆ¬çš„è‡€éƒ¨è½®å»“ã€‚" },
        { mode: "adv", name: "åäº•å—", text: "ï¼ˆçœ‹ç€å±å¹•ä¸Šçš„ç‚¹èµæ•°ï¼‰â€¦â€¦", show: ["mina"], focus: "mina" },
        { mode: "nvl", text: "è¿™æ˜¯å¥¹çš„åå›ï¼Œæ˜¯å¥¹ä¸ºè‡ªå·±åˆ’å‡ºçš„ä¸€å°å—é¢†åœ°ï¼Œåœ¨è¿™é‡Œå¥¹å¯ä»¥æ„Ÿå—åˆ°æŒæ§æ„Ÿã€‚" },
        { mode: "nvl", text: "é‚£äº›è¯„è®ºå’Œç§ä¿¡åƒæ½®æ°´ä¸€æ ·æ¶Œæ¥ï¼Œæœ‰èµç¾ï¼Œæœ‰ä¸‹æµçš„é‚€çº¦ï¼Œæœ‰ä¸çŸ¥ç¾è€»çš„å¹»æƒ³ã€‚" },
        { mode: "nvl", text: "å¥¹ä»ä¸å›åº”ï¼Œåªæ˜¯å†·çœ¼æ—è§‚ï¼Œåƒæ˜¯åœ¨è§‚å¯Ÿä¸€åœºæ— å…³è‡ªå·±çš„å®éªŒã€‚" },
        { mode: "nvl", text: "â€¦â€¦å¥¹æ²¡æœ‰æƒ³åˆ°è¿™å…¶ä¸­ä¼šæœ‰å‡‘å´çº±å¤ã€‚" },
        
        // === åœºæ™¯ 4 ===
        { mode: "nvl", text: "ã€åœºæ™¯åˆ‡æ¢ï¼šå­¦æ ¡å›¾ä¹¦é¦† / å‘¨äº”ä¸‹åˆã€‘", bg: "library.jpg" },
        { mode: "nvl", text: "å‘¨äº”ä¸‹åˆçš„å›¾ä¹¦é¦†æ€»æ˜¯æ ¼å¤–å®‰é™ï¼Œå¤§å¤šæ•°å­¦ç”Ÿå·²ç»å¼€å§‹äº†å‘¨æœ«è®¡åˆ’ã€‚" },
        { mode: "nvl", text: "åäº•å—åœ¨è‡ªå·±æƒ¯å¸¸çš„è§’è½ï¼Œå€Ÿç€å›¾ä¹¦é¦†æš–é»„è‰²çš„ç¯å…‰ç¿»é˜…ä¸€æœ¬åšé‡çš„æ–‡å­¦è¯„è®ºã€‚" },
        { mode: "nvl", text: "å‡‘å´çº±å¤ç½•è§åœ°ä¸€ä¸ªäººæ¥å­¦ä¹ ï¼Œæ²¡æœ‰äº†å¾€å¸¸é‚£ç¾¤å›´ç»•åœ¨å¥¹èº«è¾¹å½å½å–³å–³çš„æœ‹å‹ã€‚å¥¹é€‰æ‹©äº†ä¸€ä¸ªå®‰é™çš„ä½ç½®ï¼Œæ°å¥½åœ¨åäº•å—çš„å¯¹é¢ã€‚" },
        { mode: "nvl", text: "å—ä½ç€å¤´å‡è£…ä¸“æ³¨äºä¹¦æœ¬ï¼Œä½™å…‰å´å¿ä¸ä½å¾€å¯¹é¢çŸã€‚çº±å¤ç©¿ç€æ ¡æœï¼Œé¢†å¸¦æ¾æ¾åœ°æŒ‚åœ¨è„–å­ä¸Šï¼Œå¥¹çœ‹èµ·æ¥æœ‰äº›ç´¯ï¼Œçœ¼ç›ä¸‹é¢æœ‰æ·¡æ·¡çš„é’è‰²ï¼Œä½†ä»ç„¶è¯•å›¾é›†ä¸­ç²¾åŠ›åœ¨é¢å‰æ‘Šå¼€çš„è¯¾æœ¬ä¸Šã€‚" },
        
        { mode: "nvl", text: "ã€â™ª æ‰‹æœºå±å¹•äº®èµ·ã€‘" },
        { mode: "nvl", text: "çº±å¤çš„æ‰‹æœºæ”¾åœ¨æ¡Œä¸Šï¼Œå±å¹•çªç„¶äº®äº†ä¸€ä¸‹ï¼Œæ˜¾ç¤ºæœ‰æ–°æ¶ˆæ¯ã€‚", bg: "phone2.jpg" },
        { mode: "nvl", text: "åäº•å—ä¸ç»æ„åœ°ç¥äº†ä¸€çœ¼ï¼Œå¿ƒè·³å‡ ä¹åœæ»ï¼Œè¡€æ¶²å‡å›ºåœ¨è¡€ç®¡é‡Œã€‚" , sfx: "sfx_heartbeat.mp3" },
        { mode: "nvl", text: "é‚£æ˜¯å¥¹ä¸Šå‘¨å‘å¸ƒçš„ç…§ç‰‡ï¼Œå¹¶ä¸èƒ½è¯´å¾—ä¸Šå¤šéœ²éª¨ï¼Œä½†å¥¹æœ¬äººå’Œè§‚ä¼—å´éƒ½å¿ƒçŸ¥è‚šæ˜â€”â€”å¥¹ç©¿ç€å¾ˆçŸ­çš„Tæ¤å’Œæ¸…å‡‰çš„æ³³è¡£ï¼Œè…°è‚¢å’Œè‹¥éšè‹¥ç°çš„ç™½çš™è…¿æ ¹åƒæ˜¯ä¸€ä¸ªéšç§˜çš„é‚€çº¦ã€‚" },
        { mode: "nvl", text: "ç…§ç‰‡æ²¡æœ‰ç”¨ä»€ä¹ˆæ»¤é•œï¼Œè¡£æ–™é—´éœ²å‡ºçš„è‚Œè‚¤éšçº¦å¯è§ï¼Œæ¬²ç›–å¼¥å½°åœ°å‹¾å‹’å‡ºè…°è‚¢çš„æ›²çº¿ã€‚" },
        { mode: "nvl", text: "å‡‘å´çº±å¤æŠŠé‚£å¼ ç…§ç‰‡è®¾ä¸ºäº†å£çº¸ã€‚" },
        { mode: "adv", name: "", text: "åäº•å—çš„å‘¼å¸æš‚åœäº†ã€‚", show: ["mina"], focus: "mina" },
        
        {
            mode: "adv", type: "choice",
            options: [
                { text: "æ„Ÿåˆ°ææƒ§å’Œç¾è€»ï¼Œæƒ³è¦é€ƒç¦»", next: "feel_shame", effect: { love: -5 } },
                { text: "å¿ƒè„å‰§çƒˆè·³åŠ¨ï¼Œäº§ç”Ÿä¸€ä¸ªç–‘é—®", next: "feel_curious", effect: { lust: 10, sync: 10 } } 
            ]
        },

        { label: "feel_shame", mode: "nvl", text: "åäº•å—æ„Ÿåˆ°ä¸€é˜µææƒ§å’Œç¾è€»æ¶Œä¸Šå¿ƒå¤´ï¼Œå¥¹æƒ³è¦é€ƒç¦»è¿™é‡Œï¼Œé€ƒç¦»è¿™ä¸ªè®©å¥¹çª’æ¯çš„å›¾ä¹¦é¦†ã€‚", show: ["mina"], focus: "mina" },
        { jump: "chapter_end" },

        { label: "feel_curious", mode: "nvl", text: "åäº•å—çš„è€³æœµçƒ§äº†èµ·æ¥ï¼Œä¸€è‚¡çƒ­æµä»è„–å­çˆ¬ä¸Šè„¸é¢Šï¼Œå¥¹å¼ºè¿«è‡ªå·±æŠŠè§†çº¿ç§»å›ä¹¦æœ¬ï¼Œå´å‘ç°è‡ªå·±ä¸€ä¸ªå­—ä¹Ÿçœ‹ä¸è¿›å»ï¼Œå­—æ¯åƒæ˜¯æ‰­æ›²çš„èš‚èšåœ¨é¡µé¢ä¸Šçˆ¬è¡Œã€‚", show: ["mina"], focus: "mina" },
        { mode: "adv", name: "", text: "å¥¹çš„è„‘æµ·é‡Œåªæœ‰ä¸€ä¸ªé—®é¢˜ï¼šå‡‘å´çº±å¤çŸ¥é“é‚£æ˜¯å¥¹å—ï¼Ÿ" },
        { mode: "nvl", text: "å¥¹å·å·åœ°æŠ¬çœ¼è§‚å¯Ÿå¯¹é¢çš„å¥³å­©ã€‚å‡‘å´çº±å¤æ‹¿èµ·æ‰‹æœºå›å¤äº†ä¿¡æ¯ï¼Œå˜´è§’å¾®å¾®ä¸Šæ‰¬ï¼Œç„¶ååˆåŸ‹å¤´è¿›ä¹¦æœ¬é‡Œã€‚", bg: "library.jpg" },
        { mode: "nvl", text: "åäº•å—å’¬ç€ä¸‹å”‡ï¼Œå¿ƒè„åœ¨èƒ¸è…”é‡Œå‰§çƒˆè·³åŠ¨ã€‚" },
        { mode: "adv", name: "åäº•å—", text: "ï¼ˆå†…å¿ƒï¼‰çº±å¤â€¦â€¦å¥¹æ˜¯çœŸçš„è§‰å¾—ç…§ç‰‡æ¼‚äº®ï¼Œè¿˜æ˜¯å’Œé‚£äº›å‘é€ä½ä¿—ç§ä¿¡çš„äººä¸€æ ·ï¼Œå¯¹ç…§ç‰‡é‡Œçš„èº«ä½“æœ‰ç€ä¸‹æµçš„å¹»æƒ³ï¼Ÿ", show: ["mina"], focus: "mina" },

        { label: "chapter_end", mode: "nvl", text: "é‚£ä¸ªæ€»æ˜¯é˜³å…‰ç¿çƒ‚ï¼Œè‡ªç”±è‡ªåœ¨çš„ï¼Œå°å¤ªé˜³ä¸€æ ·çš„å¥³å­©ï¼Œä¹Ÿä¼šæœ‰è¿™æ ·çš„ä¸€é¢å—ï¼Ÿ" },
        { mode: "nvl", text: "â€”â€” ç¬¬ä¸€ç«  å®Œ â€”â€”" },
// ã€æ–°å¢ã€‘åœ¨è¿™é‡Œæ’å…¥è§£é”ä»£ç ï¼
        // åªè¦è¯»åˆ°è¿™ä¸€è¡Œï¼Œç³»ç»Ÿå°±ä¼šæ°¸ä¹…è®°å½•ï¼šç¬¬äºŒç« å·²è§£é”
        { mode: "code", action: () => {
            if(!gameProgress.unlockedChapters.includes(2)) {
                gameProgress.unlockedChapters.push(2);
                saveSystemData(); // ä¿å­˜åˆ°æµè§ˆå™¨ç¼“å­˜
            }
        }},

        // ç„¶åå†æ˜¾ç¤ºé€‰é¡¹
        {
            mode: "adv", type: "choice",
            options: [
                { text: "è¿›å…¥ä¸‹ä¸€ç« ï¼šé è¿‘çš„è·ç¦»", next: "ch2_start" }, 
                { text: "è¿”å›æ ‡é¢˜ç”»é¢", next: "title_return" }
            ]
        }, 

        // =========================================
        //             ç¬¬äºŒç« ï¼šä¸æ˜¯çš„ï¼Œåªæœ‰ä½ 
        // =========================================        

        // === åœºæ™¯ 1ï¼šåäº•å—çš„æˆ¿é—´ / ç‹¬ç™½ ===
        { label: "ch2_start", mode: "nvl", text: "åäº•å—çªç„¶æ„è¯†åˆ°ï¼Œè‡ªå·±å¯¹å‡‘å´çº±å¤çš„äº†è§£å…¶å®å¾ˆæœ‰é™ã€‚å¥¹ä»¬ç”Ÿæ´»åœ¨å¦‚æ­¤æ¥è¿‘çš„è½¨é“ä¸Šï¼Œå´ä»æœªçœŸæ­£äº¤æ±‡ã€‚", bg: "minaroom_night.jpg", bgm: "bgm_quiet.mp3" },
        { mode: "nvl", text: "çº±å¤ä¼šåœ¨åŠå¤œå·å·çœ‹é‚£äº›ç…§ç‰‡å—ï¼Ÿ" },
        { mode: "nvl", text: "å¥¹æ·±å¸äº†ä¸€å£æ°”ï¼Œç†æ™ºåˆé‡æ–°å é¢†å¤§è„‘ã€‚å¥¹æ‰€æœ‰çš„ç…§ç‰‡éƒ½æ²¡æœ‰éœ²å‡ºä»»ä½•èƒ½æ˜¾ç¤ºå‡ºèº«ä»½çš„ä¸œè¥¿ï¼Œå‡‘å´ä¸å¯èƒ½çœ‹å¾—å‡ºæ¥ã€‚" },
        { mode: "nvl", text: "ä¸æ­¤åŒæ—¶ï¼Œä¸€ä¸ªä¸è¯·è‡ªæ¥çš„å¿µå¤´åœ¨å—çš„è„‘æµ·ä¸­ç”Ÿæ ¹â€”â€”" },
        { mode: "adv", name: "åäº•å—", text: "ï¼ˆå†…å¿ƒï¼‰å¦‚æœçº±å¤çŸ¥é“é‚£æ˜¯å¥¹ï¼Œä¼šæ€æ ·çœ‹å¾…å¥¹ï¼Ÿä¼šé„™è§†å¥¹å—ï¼Ÿè¿˜æ˜¯ä¼šå¯¹å¥¹äº§ç”Ÿæ–°çš„å…´è¶£ï¼Ÿ", show: ["mina"], focus: "mina" },

// === åœºæ™¯ 2ï¼šå›å®¶ / å¯»æ‰¾è´¦å· ===
        { mode: "nvl", text: "å›åˆ°å®¶ï¼Œåäº•å—æŠŠä¹¦åŒ…æ‰”åœ¨åºŠä¸Šï¼Œå¿ƒä¸åœ¨ç„‰åœ°å®Œæˆäº†æ™šé¤å’Œå®¶åº­ä½œä¸šã€‚" },
        { mode: "nvl", text: "æ´—å®Œæ¾¡åï¼Œå¥¹è£¹ç€æµ´å·¾ååœ¨åºŠè¾¹ï¼Œç›¯ç€è‡ªå·±çš„æ‰‹æœºå±å¹•è®¸ä¹…ï¼Œæ‰‹æŒ‡æ‚¬åœ¨å±å¹•ä¸Šæ–¹ï¼Œåƒæ˜¯åœ¨è¿›è¡Œä¸€åœºæ— å£°çš„ææ–—ã€‚", bg: "phone.png" },
        { mode: "nvl", text: "æœ€ç»ˆï¼Œå¥¹ç‚¹å¼€äº†é‚£ä¸ªåŒ¿åè´¦å·çš„é¡µé¢ã€‚å‡ æ¡æ–°çš„ç§ä¿¡èººåœ¨æ”¶ä»¶ç®±é‡Œï¼Œä½†å¥¹æ— è§†äº†å®ƒä»¬ã€‚" },
        
        // ã€è®¾ç½®æ ‡ç­¾ï¼Œç”¨äºå¾ªç¯è·³è½¬ã€‘
        { label: "search_loop_start", mode: "nvl", text: "å¥¹å’¬ç€ä¸‹å”‡ï¼Œæ‰‹æŒ‡åœ¨æœç´¢æ¡†æ‚¬åœã€‚è¯¥æ€ä¹ˆæ‰¾åˆ°çº±å¤çš„é‚£ä¸ªå°å·å‘¢ï¼Ÿ" },

        {
            mode: "adv", type: "choice",
            options: [
                // æ­£ç¡®é€‰é¡¹ï¼šå¯¹åº”åŸå‰§æƒ…çš„â€œç¿»é˜…ç²‰ä¸åˆ—è¡¨â€
                { text: "è‡ªå·±çš„ç²‰ä¸ä¹Ÿä¸ç®—ç‰¹åˆ«å¤šï¼Œç¿»ä¸€ç¿»ç²‰ä¸åˆ—è¡¨å§", next: "check_followers", effect: { sync: 2 } }, 
                // é”™è¯¯é€‰é¡¹ï¼šè™½ç„¶é”™äº†ï¼Œä½†ä¼šè®©ç©å®¶é‡æ–°é€‰
                { text: "è¯•è¯•çœ‹æœç´¢çº±å¤çš„å…¨å 'Minatozaki Sana'", next: "search_real_name", effect: { sync: -1 } }, 
                // BEé€‰é¡¹ï¼šç›´æ¥BE
                { text: "è¿™æ ·çª¥æ¢â€¦çœŸçš„å¥½å—ï¼Œè¿˜æ˜¯ç®—äº†å§", next: "bad_end_2", effect: { love: -2 } }
            ]
        },

        // --- é”™è¯¯åˆ†æ”¯ï¼šæœå¤§å (å¾ªç¯) ---
        { label: "search_real_name", mode: "adv", name: "åäº•å—", text: "â€œminatoâ€¦zakiâ€¦â€" },
        { mode: "nvl", text: "åäº•å—å°å¿ƒç¿¼ç¿¼åœ°è¾“å…¥äº†é‚£ä¸ªç†Ÿæ‚‰çš„åå­—ï¼Œç‚¹å‡»æœç´¢ã€‚" },
        { mode: "nvl", text: "å±å¹•ä¸Šè·³å‡ºæ¥çš„åªæœ‰çº±å¤é‚£ä¸ªå…¨æ˜¯é£æ™¯ç…§å’Œç”œå“æ‰“å¡çš„å…¬å¼€è´¦å·ï¼Œé«˜ä¸­ç”Ÿçœ¼ç›äº®æ™¶æ™¶ï¼Œå¯¹ç€é•œå¤´ç¬‘å¾—ç¿çƒ‚ã€‚" },
        { mode: "nvl", text: "å°±ç®—æ¯å¤©éƒ½èƒ½å¤Ÿè§åˆ°çº±å¤ï¼Œåäº•å—è¿˜æ˜¯ä¼šå› ä¸ºè¿™çªç„¶å‡ºç°çš„è¿™æ ·çš„ç¬‘å®¹è€Œå¿ƒè·³åŠ é€Ÿï¼Œéšå³è€Œæ¥çš„æ˜¯éšç§˜çš„ç¾æ„§å¿ƒæƒ…ã€‚" },
        { mode: "nvl", text: "å¥¹å‡ ä¹éƒ½è¦æ”¾å¼ƒäº†ï¼Œè¿™æ ·çš„çº±å¤ï¼Œæ€ä¹ˆå¯èƒ½ä¼šå·å·å…³æ³¨åŒ¿åæ“¦è¾¹è´¦å·å‘¢ï¼Ÿä½†æ˜¯å›¾ä¹¦é¦†çœ‹åˆ°çš„é‚£å¼ ç…§ç‰‡åˆè®©åäº•å—æ„Ÿåˆ°ä¸ç”˜å¿ƒã€‚" },
        { mode: "adv", name: "åäº•å—", text: "â€œæˆ‘åœ¨æƒ³ä»€ä¹ˆå‘¢â€¦â€¦å°±ç®—æ˜¯çœŸçš„ï¼Œå¥¹ä¹Ÿä¸å¯èƒ½ç”¨å¤§ååšè¿™ç§äº‹çš„å§ã€‚â€" },
        { mode: "nvl", text: "è¿™æ¡è·¯èµ°ä¸é€šã€‚åäº•å—å¹äº†å£æ°”ï¼Œé€€å›äº†æœç´¢ç•Œé¢ã€‚" },
        // ã€å…³é”®é€»è¾‘ã€‘è·³å›é€‰æ‹©å¼€å¤´ï¼Œè®©ç©å®¶é‡é€‰
        { jump: "search_loop_start" },

        // --- æ­»äº¡åˆ†æ”¯ï¼šæ”¾å¼ƒ (BE) ---
        { label: "bad_end_2", mode: "nvl", text: "æ‰‹æŒ‡åœ¨è½ä¸‹å‰åœä½äº†ã€‚åäº•å—è‹¦ç¬‘äº†ä¸€ä¸‹ï¼Œè‡ªå·±è¿™æ˜¯åœ¨åšä»€ä¹ˆå‘¢ï¼Ÿåƒä¸ªå˜æ€ä¸€æ ·ã€‚" },
        { mode: "nvl", text: "çº±å¤å¯èƒ½åªæ˜¯å¶ç„¶åœ°åœ¨ä»€ä¹ˆåœ°æ–¹çœ‹åˆ°äº†è¿™å¼ å›¾ï¼Œå¹¶ä¸çŸ¥é“å›¾ç‰‡æ¥æºçš„è´¦å·ã€‚" },
        { mode: "nvl", text: "è¿™æ ·è´¹åŠ²å¿ƒæœºåœ°å¯»æ‰¾ï¼ŒçœŸçš„æœ‰æ„ä¹‰å—ï¼Ÿåæ­£å¥¹ä»¬ä¸¤ä¸ªï¼Œä¹Ÿä»…ä»…æ˜¯èƒ½è¯´ä¸Šä¸¤å¥è¯çš„é‚»å±…è€Œå·²ã€‚" },
        { mode: "nvl", text: "å¥¹å…³æ‰äº†æ‰‹æœºï¼Œå‡†å¤‡æ—©ç‚¹å…¥ç¡ã€‚" },
        { mode: "bg_only", bg: "#000", bgm: "bgm_dream_hazy.mp3" }, // å»ºè®®é…ä¸€æ®µè¿·ç¦»çš„BGM
        
        { mode: "nvl", text: "çœ¼å‰æ˜æš—ï¼Œç©ºæ°”ç‡¥çƒ­ï¼Œå‘¨å›´çš„ä¸€åˆ‡å˜å¾—æœ¦èƒ§è€Œç²˜ç¨ ã€‚" },

        { mode: "nvl", text: "å‡‘å´çº±å¤çš„é¼»å¤´äº®æ™¶æ™¶ï¼Œçœ¼ç›äº®æ™¶æ™¶ï¼Œç”±äºä¿¯è§†çš„è§’åº¦å¹¶ä¸æ˜¾å¾—å¯çˆ±ï¼Œè€Œæµå‡ºä¸€è‚¡å¥¹æœ¬äººéƒ½æ²¡æœ‰æ„è¯†åˆ°çš„å æœ‰æ¬²å’Œå‡¶çŒ›ã€‚",bg: "sana_dream.jpg" },
        { mode: "nvl", text: "åäº•å—è¿™æ‰æ³¨æ„åˆ°å‡‘å´çº±å¤å‹åœ¨å¥¹çš„èº«ä½“ä¸Šã€‚å¥¹ä»¬éƒ½ç©¿å¾—å¾ˆå°‘ï¼Œå¤´å‘ç¼ ç€å¤´å‘ï¼Œçš®è‚¤è´´ç€çš®è‚¤ï¼Œçƒ­æ°”è…¾è…¾çš„ä½“æ¸©å…¨ç„¶æ— é—´éš”åœ°ä¼ è¿‡æ¥ï¼Œåäº•å—ä¹Ÿæ„Ÿè§‰åˆ°ç‡¥çƒ­éš¾è€äº†ã€‚" },

        { mode: "nvl", text: "å¥¹å‘åç¼©äº†ç¼©èº«ä½“ï¼Œå´å› ä¸ºèººåœ¨åºŠä¸Šçš„å§¿åŠ¿é¿æ— å¯é¿ã€‚" },
        { mode: "nvl", text: "å‡‘å´çº±å¤çš„å˜´å”‡ç»ˆäºè½ä¸‹æ¥ï¼Œäºæ­¤åŒæ—¶çš„æ˜¯å¥¹é’»è¿›è‡ªå·±ç¡è¡£é‡Œçš„æ‰‹æŒã€‚" },
        { mode: "nvl", text: "èˆŒå°–è¢«æ€¥ä¿ƒåœ°æ¨ç€ï¼Œå·ç€ï¼Œå®å¸ç€ï¼Œåäº•å—å¯æ€œåœ°å“¼ï¼Œå´å› ä¸ºæ‰­è…°çš„åŠ¨ä½œæŠŠä¹³å°–é€è¿›å¥¹çš„æŒå¿ƒã€‚" },
        
        { mode: "nvl", text: "è¢«æä½äº†ï¼Œåäº•å—èŒ«ç„¶åœ°æƒ³ï¼Œéšååˆè¢«èƒ¸å‰æ¹¿çƒ­çš„è§¦æ„Ÿè€ŒæŠ‘åˆ¶ä¸ä½åœ°å°å£°å°–å«ã€‚" },
        { mode: "nvl", text: "å‡‘å´çº±å¤æ˜¯å¦çœŸçš„æ˜¯å°ç‹—å˜çš„ï¼Ÿåäº•å—ä¸åˆæ—¶å®œåœ°æƒ³åˆ°è¿™ä¸ªé—®é¢˜ã€‚å¥¹åœ¨å¥¹å¼¯èµ·çœ¼ç›éœ²å‡ºé‚£ç§æ²¡æœ‰äººèƒ½å¤Ÿä¸å¿ƒè½¯çš„é¡½çš®ç¬‘å®¹æ—¶è¿™æ ·æƒ³è¿‡ï¼Œä½†æ­¤åˆ»å‡‘å´çº±å¤çš„èˆŒå°–å·²ç»åœ¨ååƒå¥¹çš„ä¹³è‚‰ï¼Œè¿™ä¸ªé—®é¢˜å°±æ— å¯é¿å…åœ°å¸¦ä¸Šäº†è‰²æƒ…çš„å«ä¹‰ã€‚" },

        { mode: "adv", name: "åäº•å—", text: "â€œçº±å¤â€¦â€¦çº±ç³–â€¦â€¦â€", show: ["sana_dream"], focus: "sana_dream" },
        { mode: "nvl", text: "åäº•å—å«ç³Šåœ°å«ï¼Œå«å¥¹çš„åå­—ï¼Œå«å¥¹çš„æ˜µç§°ã€‚" },
        
        { mode: "adv", name: "å‡‘å´çº±å¤", text: "â€œç±³ç³–ï¼Œç±³ç³–ã€‚â€" },
        { mode: "nvl", text: "äºæ˜¯å‡‘å´çº±å¤ä¹Ÿå«å¥¹ï¼Œåœ¨å¥¹çš„è€³è¾¹ï¼Œå£°éŸ³ä½ä½çš„ã€‚" },
        { mode: "adv", name: "å‡‘å´çº±å¤", text: "â€œæƒ³è¦å—?â€" },

        { mode: "nvl", text: "åº”è¯¥è¦å›ç­”çš„ï¼Œåäº•å—è¿™æ ·æƒ³ç€ï¼Œä½†å£°éŸ³åƒå¡åœ¨å–‰å’™é‡Œä¸€æ ·å‘ä¸å‡ºæ¥ã€‚" },
        { mode: "nvl", text: "å¥¹åªèƒ½æŠ¬èµ·æ‰‹ï¼Œæƒ³è¦å»æŠ±å‡‘å´çº±å¤ï¼Œæ‰‹å´è½¯ç»µç»µçš„ä½¿ä¸ä¸ŠåŠ›æ°”ï¼Œåªæ˜¯è™šè™šåœ°æ­åœ¨å¥¹çš„è‚©è†€ä¸Šã€‚" },

        { mode: "nvl", text: "å‡‘å´çº±å¤çš„æ‰‹å¼€å§‹å¾€ä¸‹ç§»åŠ¨äº†ã€‚ç¼“æ…¢çš„ï¼Œè¯•æ¢çš„ï¼ŒæŒ‡å°–è½»è½»æ“¦è¿‡å¥¹çš„å°è…¹ï¼Œåˆåœåœ¨é‚£é‡Œæ‰“è½¬ã€‚" },
        { mode: "adv", name: "å‡‘å´çº±å¤", text: "â€œè¿™é‡Œâ€¦â€¦â€" },
        { mode: "nvl", text: "å‡‘å´çº±å¤çš„å£°éŸ³å¸¦ç€ç¬‘æ„ã€‚" },
        { mode: "adv", name: "å‡‘å´çº±å¤", text: "â€œå—è¿™é‡Œï¼Œå·²ç»æ¹¿æˆè¿™æ ·äº†ã€‚â€" },

        { mode: "nvl", text: "åäº•å—è§‰å¾—ç¾è€»ï¼Œæƒ³è¦å¹¶æ‹¢è…¿ï¼Œå´å‘ç°è‡ªå·±çš„è…¿æ—©å°±è¢«åˆ†å¼€äº†ã€‚" },
        { mode: "nvl", text: "å‡‘å´çº±å¤è·ªåœ¨å¥¹ä¸¤è…¿ä¹‹é—´ï¼Œé‚£åŒæµ…è¤è‰²çš„çœ¼ç›åœ¨æ˜æš—é‡Œäº®å¾—å“äººï¼Œä¸“æ³¨åœ°çœ‹ç€å¥¹ã€‚è¢«è¿™æ ·çœ‹ç€çš„æ—¶å€™ï¼Œåäº•å—æ€»è§‰å¾—è‡ªå·±æ— å¤„å¯é€ƒï¼Œæ‰€æœ‰çš„ç§˜å¯†éƒ½è¢«çœ‹é€äº†ã€‚" },

        { mode: "adv", name: "åäº•å—", text: "â€œçº±å¤â€¦â€¦â€" },
        { mode: "nvl", text: "å¥¹ç»ˆäºèƒ½å‘å‡ºå£°éŸ³äº†ï¼Œä½†åªèƒ½å«å‡ºè¿™ä¸€ä¸ªåå­—ã€‚" },

        { mode: "adv", name: "å‡‘å´çº±å¤", text: "â€œå—ã€‚â€" },
        { mode: "nvl", text: "å‡‘å´çº±å¤ä¿¯ä¸‹èº«ï¼Œé¢å¤´æŠµç€å¥¹çš„é¢å¤´ï¼Œå‘¼å¸çƒ­è…¾è…¾åœ°æ´’åœ¨å¥¹è„¸ä¸Šã€‚å¥¹ä»¬ç¦»å¾—é‚£ä¹ˆè¿‘ï¼Œè¿‘åˆ°åäº•å—èƒ½çœ‹æ¸…å‡‘å´çº±å¤è„¸é¢Šä¸Šæ¯ä¸€æ ¹ç»†å°çš„ç»’æ¯›ã€‚" },
        { mode: "adv", name: "å‡‘å´çº±å¤", text: "â€œå—ï¼Œæˆ‘è¦è¿›æ¥äº†ã€‚â€" },

        { mode: "nvl", text: "è¿›æ¥äº†ã€‚" },
        { mode: "nvl", text: "åäº•å—åŒçœ¼å¤±ç„¦ï¼Œä»°èµ·å¤´å¤§å£åœ°å–˜æ¯ã€‚å‡‘å´çº±å¤çš„æŒ‡å°–è½»è½»åœ°åˆºè¿›å¥¹çš„ç©´å£ï¼Œæ¯”èµ·ç—›æ›´å…ˆåˆ°æ¥çš„æ˜¯è¢«å¡«æ»¡çš„å¼‚ç‰©æ„Ÿã€‚", sfx: "sfx_heartbeat_fast.mp3" },
        { mode: "nvl", text: "å¥¹çš„èº«ä½“å¼“èµ·ï¼Œå°è…¹ç´§ç»·ï¼ŒæŒ‡ç”²ä¸è‡ªè§‰åœ°æŠ è¿›å‡‘å´çº±å¤çš„è‚©è†€ã€‚" },
        { mode: "adv", name: "åäº•å—", text: "â€œä¸èˆ’æœï¼Œçº±å¤ï¼Œä¸èˆ’æœâ€¦â€¦â€" },
        { mode: "nvl", text: "å¥¹å“­ç€å°å£°åœ°å«ã€‚" },

        { mode: "nvl", text: "å‡‘å´çº±å¤çš„å»è½»è½»çš„ï¼Œä¸€ä¸‹ä¸€ä¸‹åœ°è½åœ¨å¥¹çš„è„¸ä¸Šã€‚" },
        { mode: "adv", name: "å‡‘å´çº±å¤", text: "â€œç–¼å—ï¼Ÿâ€" },

        { mode: "nvl", text: "ä¸ç–¼ã€‚åäº•å—æƒ³è¿™æ ·è¯´ï¼Œä½†å¥¹è¯´ä¸å‡ºæ¥ã€‚å¥¹åªèƒ½æ‘‡å¤´ï¼Œåˆä¸»åŠ¨åœ°æŠ¬èµ·è…°ã€‚" },
        { mode: "adv", name: "å‡‘å´çº±å¤", text: "â€œç±³ç³–ï¼Œç±³ç³–ï¼Œä¹–ã€‚â€" },
        { mode: "nvl", text: "å‡‘å´çº±å¤å»è¿‡å¥¹çš„çœ‰æ¯›ï¼Œå¥¹çš„çœ¼è§’ï¼Œåˆç”¨é‚£ç§è›Šæƒ‘äººå¿ƒçš„æ¸©æŸ”è¯­è°ƒæ¥å«å¥¹çš„åå­—ã€‚" },
        { mode: "nvl", text: "å¥¹çš„æ‰‹æŒ‡é€€å‡ºæ¥ï¼Œè€å¿ƒåœ°æ‰å¼„ç€å¥¹é¢¤å·å·åœ°ç«‹èµ·çš„èŠ±æ ¸ï¼Œåˆåœ¨åäº•å—å¤¹ä½å¥¹çš„æ‰‹è‡‚æ—¶æŠŠæŒ‡å°–é‡æ–°æ¢è¿›ç©´å£ï¼Œä¸€ä¸‹ï¼Œä¸€ä¸‹ï¼Œåˆä¸€ä¸‹ã€‚" },
        { mode: "nvl", text: "ç²˜è…»çš„çˆ±æ¶²é¡ºç€å¥¹çš„æ‰‹è…•å¾€ä¸‹æµï¼Œåäº•å—çš„èº«ä½“è·Ÿç€è½»è½»æŠ–ã€‚" }, // è¿™é‡Œçš„æ–‡å­—å¾ˆæœ‰ç”»é¢æ„Ÿ

        { mode: "nvl", text: "ä¸çŸ¥é“è¯¥æ€ä¹ˆåŠæ‰å¥½äº†ã€‚" },
        { mode: "nvl", text: "åäº•å—çš„è„šè¶¾æ— æªåœ°èœ·ç¼©ç€ï¼Œå¥¹è§‰å¾—è‡ªå·±åƒæ¼‚æµ®åœ¨æ°´é¢ä¸Šï¼Œè¢«ä¸€æ³¢ä¸€æ³¢çš„æµªæ½®æ¨ç€ï¼Œæ¨å‘æŸä¸ªå¥¹æ—¢æœŸå¾…åˆå®³æ€•çš„åœ°æ–¹ã€‚" },
        { mode: "nvl", text: "å¥¹å¬è§è‡ªå·±å‘å‡ºä¸€äº›ä¸æˆå¥çš„å£°éŸ³ï¼Œåˆç¾è€»åˆä¸å—æ§åˆ¶ã€‚" },
        { mode: "nvl", text: "å‡‘å´çº±å¤çš„å‘¼å¸ä¹Ÿå˜å¾—æ€¥ä¿ƒäº†ï¼Œå¥¹ä½ç€å¤´ï¼ŒæŠŠè„¸åŸ‹åœ¨åäº•å—çš„é¢ˆçªï¼Œé•¿é•¿çš„å¤´å‘å‚ä¸‹æ¥ï¼Œç—’ç—’åœ°æ‰«è¿‡åäº•å—çš„è‚©è†€å’Œé”éª¨ã€‚" },

        { mode: "adv", name: "å‡‘å´çº±å¤", text: "â€œå—â€¦â€¦â€" },
        { mode: "nvl", text: "å‡‘å´çº±å¤åˆå«å¥¹ï¼Œå£°éŸ³é‡Œå¸¦ç€å“­è…”ã€‚" },
        { mode: "adv", name: "å‡‘å´çº±å¤", text: "â€œå—ï¼Œæˆ‘å¥½å–œæ¬¢ä½ ã€‚â€" },

        { mode: "nvl", text: "è¿™å¥è¯åƒä¸€æ ¹å¯¼ç«ç´¢ã€‚", sfx: "sfx_climax_ringing.mp3" }, // å»ºè®®è¿™é‡ŒåŠ ä¸€ä¸ªè€³é¸£å£°æˆ–è€…é«˜æ½®éŸ³æ•ˆ
        { mode: "nvl", text: "åäº•å—è§‰å¾—èº«ä½“é‡ŒæŸæ ¹ç»·ç´§çš„å¼¦çªç„¶æ–­äº†ï¼Œå¿«æ„Ÿåƒæ½®æ°´ä¸€æ ·æ¶Œä¸Šæ¥ï¼Œé“ºå¤©ç›–åœ°çš„ï¼Œè®©å¥¹ä»€ä¹ˆéƒ½æƒ³ä¸äº†äº†ã€‚" },
        { mode: "nvl", text: "å¥¹çš„èº«ä½“ç»·ç´§ï¼Œé¢¤æŠ–ï¼Œç„¶åâ€”â€”" },

        { mode: "bg_only", bg: "#fff", effect: "flash" }, // ç™½å±é—ªçƒæ•ˆæœ
        { mode: "nvl", text: "åäº•å—çå¼€äº†çœ¼ç›ã€‚", bg: "minaroom_morning_grey.jpg", bgm: "stop" }, // éŸ³ä¹æˆ›ç„¶è€Œæ­¢ï¼ŒèƒŒæ™¯åˆ‡æ¢ä¸ºæ¸…æ™¨å§å®¤

        { mode: "nvl", text: "å§å®¤é‡Œå¾ˆå®‰é™ï¼Œåªæœ‰ç©ºè°ƒè½»å¾®çš„å—¡å—¡å£°ã€‚" },
        { mode: "nvl", text: "çª—å¸˜ç¼éš™é‡Œé€è¿›æ¥ä¸€ä¸ç°è’™è’™çš„æ™¨å…‰ï¼Œå¤©è¿˜æ²¡æœ‰å®Œå…¨äº®ã€‚" },
        { mode: "nvl", text: "å¥¹å…¨èº«éƒ½è¢«æ±—æµ¸é€äº†ï¼Œè…¿é—´ä¸€ç‰‡ç²˜è…»æ½®æ¹¿ï¼Œè´´èº«çš„è¡£ç‰©ç‹¼ç‹ˆåœ°é»åœ¨çš®è‚¤ä¸Šã€‚" },
        { mode: "nvl", text: "åäº•å—é—­ä¸Šçœ¼ç›ï¼Œæ·±å¸äº†ä¸€å£æ°”ã€‚" },

        { mode: "nvl", text: "å‡‘å´çº±å¤å°†æ°¸è¿œä¸ä¼šçŸ¥é“ä»Šå¤©çš„äº‹ã€‚" },

        { mode: "nvl", text: "ã€Bad Ending: ç‹¬è§’æˆã€‘" }, // æˆ‘ç»™è¿™ä¸ªç»“å±€èµ·çš„åå­—ï¼Œä½ å¯ä»¥æ”¹
                { mode: "code", action: () => unlockEnding("missed_opportunity") },
        { jump: "title_return" },

        // --- æ­£ç¡®åˆ†æ”¯ï¼šæŸ¥ç²‰ä¸åˆ—è¡¨ (ç»§ç»­ä¸»çº¿) ---
        { label: "check_followers", mode: "nvl", text: "å¦‚æœé‚£ä¸ªå¸å·å…³æ³¨äº†è‡ªå·±ï¼Œé‚£ä¸€å®šåœ¨ç²‰ä¸åˆ—è¡¨é‡Œã€‚è™½ç„¶è¿™æ˜¯ä¸ªç¬¨åŠæ³•ï¼Œä½†ä¹Ÿæ˜¯æœ€å¯èƒ½çš„åŠæ³•ã€‚" },
        { mode: "nvl", text: "åäº•å—å¼€å§‹è€å¿ƒåœ°ç¿»é˜…æ¼«é•¿çš„åˆ—è¡¨ï¼Œæ‰‹æŒ‡æœºæ¢°åœ°æ»‘åŠ¨ç€ã€‚" },
        { mode: "nvl", text: "èŠ±äº†ä¸€äº›æ—¶é—´ï¼Œä½†è¿˜æ˜¯å¾ˆè½»æ¾å°±æ‰¾åˆ°äº†ã€‚" },
        
        // (ä»¥ä¸‹æ¥å›åŸå‰§æƒ…)
        { mode: "nvl", text: "å‡‘å´çº±å¤å¹¶æ²¡æœ‰ç”¨å¥¹å¸¸ç”¨çš„é‚£ä¸ªè´¦å·ï¼Œåªä¸è¿‡è¿™ä¸ªä¸€ç‰‡ç©ºç™½çš„æ–°è´¦å·çš„æ˜µç§°æ˜¯ååˆ†æ˜æ˜¾çš„â€œsana1229â€ï¼Œå¤´åƒå’Œåˆå¥¹çš„ LINE è´¦å·ç›¸åŒã€‚" },
        { mode: "nvl", text: "åäº•å—é¡ºç€ç‚¹å¼€äº†è¯¦ç»†è®¯æ¯ï¼Œå…³æ³¨åˆ—è¡¨ä¹Ÿæ˜¯ç©ºç©ºè¡è¡ï¼Œé‡Œé¢åªå…³æ³¨äº†è‡ªå·±ã€‚" },

        // === åœºæ™¯ 3ï¼šç‹¬å çš„å¿«æ„Ÿ ===
        { mode: "nvl", text: "æ²¡æœ‰å…¶ä»–ä»»ä½•äººï¼Œåªæœ‰æˆ‘ã€‚", bg: "minaroom_night.jpg" },
        { mode: "nvl", text: "åäº•å—å°†æ‰‹æœºæ”¾åœ¨è†ç›–ä¸Šï¼Œç›¯ç€é‚£ä¸ªç†Ÿæ‚‰çš„å¤´åƒå‡ºç¥ã€‚" },
        { mode: "nvl", text: "è‡ªç”±è‡ªåœ¨çš„ï¼Œä»¿ä½›æ²¡æœ‰ä»»ä½•ä¸œè¥¿èƒ½å›°ä½å¥¹çš„å°å¤ªé˜³ï¼Œå·å·ç”¨å°å·å…³æ³¨é»„æ¨çš„å‡‘å´çº±å¤â€¦â€¦å‘ç°é’æ¢…ç«¹é©¬çš„ç§˜å¯†çš„éšç§˜å¿«æ„Ÿåœ¨å†…å¿ƒæ»‹ç”Ÿã€‚" },
        { mode: "nvl", text: "å‡‘å´çº±å¤ä¸ä¸ºäººçŸ¥çš„è¿™ä¸€é¢ï¼Œæ­¤åˆ»è¢«å¥¹ç‹¬å ã€‚" },
        { mode: "nvl", text: "çª—å¤–æœˆå…‰æ˜äº®ï¼Œå¥¹éšçº¦èƒ½çœ‹åˆ°éš”å£çš„é‚£æ ‹æˆ¿å­é‡Œï¼Œå‡‘å´çº±å¤çš„æˆ¿é—´è¿˜äº®ç€ç¯ã€‚", bg: "windows_night.jpg" },
        
        { mode: "adv", name: "å›å¿†çš„å£°éŸ³", text: "â€œè·³ä¸‹æ¥ï¼Œæˆ‘æ¥ä½ä½ ã€‚â€", bgm: "stop" },
        { mode: "nvl", text: "å‡‘å´çº±å¤çš„å£°éŸ³å“åœ¨è€³è¾¹ã€‚",  bgm: "bgm_tension.mp3" },
        { mode: "nvl", text: "åäº•å—ç‚¹å¼€äº†â€œsana1229â€çš„èŠå¤©æ¡†ï¼Œå…³æ‰ï¼Œåˆä¸€æ¬¡æ‰“å¼€ã€‚è¿™ä¸€æ¬¡ï¼Œå¥¹å‡†å¤‡è‡ªå·±è·³ä¸‹å»äº†ã€‚" },

        // === äº’åŠ¨ç‚¹ï¼šç¬¬ä¸€æ¡ä¿¡æ¯ ===
        {
            mode: "adv", type: "choice",
            options: [
                { text: "å‘é€ï¼šâ€œå–œæ¬¢æˆ‘çš„ç…§ç‰‡ï¼Ÿâ€", next: "msg_like", effect: { love: 2, lust: 2 } }, // åŸå‰§æƒ…
                { text: "å‘é€ï¼šâ€œæ‰¾åˆ°çº±å¤äº†ã€‚â€", next: "bad_end_3", effect: { love: -5, lust: -5 } } // ä½œæ­»é€‰é¡¹
            ]
        },

        { label: "bad_end_3", mode: "nvl", text: "å‘é€å‡ºå»çš„ç¬é—´ï¼Œåäº•å—å°±åæ‚”äº†ã€‚è¿™å¬èµ·æ¥å¤ªåƒå¨èƒäº†ã€‚", bgm: "stop"  },
        { mode: "nvl", text: "å‡ ç§’é’Ÿåï¼Œå±å¹•æ˜¾ç¤ºâ€œå¯¹æ–¹å·²å°†æ‚¨å±è”½â€ã€‚" },
        { mode: "nvl", text: "ã€Bad Ending: è¢«å“è·‘çš„å°ç‹—ã€‘" },
        { jump: "title_return" },

        { label: "msg_like", mode: "nvl", text: "å‘å®Œæ¶ˆæ¯ï¼Œåäº•å—æŠŠæ‰‹æœºæ‰”åˆ°åºŠä¸Šï¼Œåƒæ˜¯å®ƒçªç„¶å˜å¾—æ»šçƒ«ã€‚å¥¹çš„å¿ƒè„ç‹‚è·³ï¼Œæ‰‹å¿ƒæ¸—å‡ºç»†å¯†çš„æ±—ç ã€‚", sfx: "sfx_heartbeat.mp3" },
        { mode: "nvl", text: "å¥¹é™é™åœ°ååœ¨åºŠæ²¿ï¼Œå¬ç€è‡ªå·±æ€¥ä¿ƒçš„å‘¼å¸å£°ï¼Œçª—å¤–éšçº¦ä¼ æ¥é‚»å±…å®¶çš„ç”µè§†å£°ã€‚", bgm: "bgm_quiet.mp3" },
        { mode: "nvl", text: "è¿‡äº†åå‡ åˆ†é’Ÿï¼Œå°±åœ¨å¥¹å‡ ä¹è¦è¯´æœè‡ªå·±æ”¾å¼ƒè¿™ä¸ªç–¯ç‹‚çš„æƒ³æ³•æ—¶ï¼Œæ‰‹æœºå±å¹•äº®äº†ã€‚", sfx: "sfx_notify.mp3" },
        { mode: "nvl", text: "åäº•å—å±ä½å‘¼å¸ï¼Œæ‰‹æŒ‡å¾®å¾®é¢¤æŠ–ç€åˆ’å¼€äº†é‚£æ¡æ–°æ¶ˆæ¯ã€‚" },
        { mode: "adv", name: "sana1229", text: "â€œå–œæ¬¢ã€‚â€" },

        // === åœºæ™¯ 5ï¼šé•œå­å‰çš„ç…§ç‰‡ ===
        { mode: "nvl", text: "å‡‘å´çº±å¤çš„å›å¤ååˆ†ç®€çŸ­ï¼Œåäº•å—è½»è½»åœ°ç¬‘äº†ä¸€ä¸‹ï¼Œæ§ç€æ‰‹æœºåœ¨åºŠä¸Šæ»šäº†ä¸€åœˆï¼Œå¥¹èƒ½æƒ³è±¡å‡‘å´çº±å¤é‚£ç§å›°æƒ‘åˆæƒŠå–œçš„è¡¨æƒ…ã€‚" },
        { mode: "nvl", text: "å¦‚æœå†ç»™å¥¹ä¸€ç‚¹æ›´å¤šçš„ä¸œè¥¿ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæ ·çš„äº‹æƒ…å‘¢ï¼Ÿ" },
        { mode: "nvl", text: "åäº•å—ç‚¹å¼€èŠå¤©æ¡†ï¼ŒçŠ¹è±«äº†ä¸€ä¸‹ï¼Œèµ·èº«èµ°åˆ°ç©¿è¡£é•œå‰ã€‚" },
        { mode: "nvl", text: "å¥¹è½»è½»æ€èµ·ç¡è£™çš„ä¸‹æ‘†ï¼Œå¯¹ç€é•œå­æ‹äº†ä¸€å¼ ç…§ç‰‡â€”â€”" },
        { mode: "nvl", text: "ç™½çš™ä¿®é•¿çš„è…¿ï¼Œç²¾å¿ƒæ„å›¾ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰éœ²å‡ºï¼Œåˆä»€ä¹ˆéƒ½è‹¥éšè‹¥ç°ã€‚" },

        { mode: "nvl", text: "å¥¹å±ä½å‘¼å¸ï¼Œå°†ç…§ç‰‡å‘äº†è¿‡å»ã€‚", sfx: "sfx_camera.mp3" },
        { mode: "nvl", text: "å‡‘å´çº±å¤çš„å›å¤å¾ˆå¿«å¼¹äº†å‡ºæ¥ã€‚", sfx: "sfx_notify.mp3" },
        { mode: "adv", name: "sana1229", text: "â€œå¾ˆæ¼‚äº®ï¼Œéå¸¸æ¼‚äº®ã€‚è¿™æ˜¯â€¦â€¦ç²‰ä¸ç¦åˆ©å—ï¼Ÿâ€" },

        { mode: "adv", name: "åäº•å—", text: "ï¼ˆæŠ¿ç€å˜´å”‡ï¼‰ç²‰ä¸ç¦åˆ©ï¼Ÿ" },
        { mode: "nvl", text: "å¥¹æ€è€ƒäº†ä¸€ä¸‹ï¼Œç„¶åæ‰“å­—å›å¤ï¼š" },
        
        // === äº’åŠ¨ç‚¹ï¼šå›å¤ç­–ç•¥ ===
        {
            mode: "adv", type: "choice",
            options: [
                { text: "â€œä¸æ˜¯çš„ï¼Œåªæœ‰ä½ ã€‚â€ ", next: "reply_only_you", effect: { love: 5, lust: 1 } },
                { text: "â€œå¦‚æœæ˜¯çº±å¤çš„è¯ï¼Œå°±æ˜¯ç¦åˆ©å“¦ã€‚â€ ", next: "reply_tease", effect: { love: 1, lust: 5 } }
            ]
        },

        { label: "reply_tease", mode: "nvl", text: "åäº•å—æ‰‹æŒ‡ä¸€æŠ–ï¼Œå·®ç‚¹æŠŠå¿ƒé‡Œæƒ³çš„åå­—æ‰“å‡ºå»ã€‚å¥¹è¿å¿™åˆ æ‰ï¼Œé‡æ–°è¾“å…¥ï¼šâ€œå¦‚æœæ˜¯ä½ çš„è¯ï¼Œå°±æ˜¯ç‰¹åˆ«ç¦åˆ©å“¦ã€‚â€" },
        { jump: "scene_control" },

        { label: "reply_only_you", mode: "adv", name: "åäº•å—", text: "â€œä¸æ˜¯çš„ï¼Œåªæœ‰ä½ ã€‚â€" },
        { jump: "scene_control" },

        // === åœºæ™¯ 6ï¼šæŒæ§æƒ ===
        { label: "scene_control", mode: "nvl", text: "å‘é€å®Œè¿™æ¡ä¿¡æ¯åï¼Œåäº•å—æœ‰ç§å¥‡æ€ªçš„æ„Ÿè§‰ï¼Œåƒæ˜¯åšäº†ä¸€ä»¶æ—¢åˆºæ¿€åˆå±é™©çš„äº‹æƒ…ã€‚" },
        { mode: "nvl", text: "å¥¹ååœ¨åºŠè¾¹ï¼ŒåŒè…¿å¾®å¾®é¢¤æŠ–ï¼Œçœ¼ç›ä¸€çœ¨ä¸çœ¨åœ°ç›¯ç€å±å¹•ï¼Œç­‰å¾…å‡‘å´çš„å›åº”ã€‚" },
        { mode: "nvl", text: "è¿™æ˜¯ä¸€åœºåªæœ‰å¥¹çŸ¥é“è§„åˆ™çš„æ¸¸æˆã€‚" },
        { mode: "nvl", text: "åœ¨å­¦æ ¡é‡Œï¼Œå¥¹å’Œå‡‘å´çº±å¤åªæ˜¯ç‚¹å¤´ä¹‹äº¤çš„é‚»å±…ï¼Œä¸€ä¸ªæ˜¯ç­ä¸Šçš„å¼€å¿ƒæœï¼Œä¸€ä¸ªæ˜¯ä¹–å·§çš„ä¼˜ç­‰ç”Ÿã€‚å‡ åç±³çš„è·ç¦»ï¼Œå¥¹ä»¬å·²ç»è¿™æ ·ç›¸æœ›äº†åå‡ å¹´ï¼Œå´ä»æœªçœŸæ­£é è¿‘ã€‚" },
        { mode: "nvl", text: "ä½†åœ¨è¿™ä¸ªæ·±å¤œï¼Œåœ¨è¿™ä¸ªåªæœ‰å¥¹ä»¬ä¸¤ä¸ªäººçš„è™šæ‹Ÿç©ºé—´é‡Œï¼Œåäº•å—çªç„¶æƒ³çœ‹çœ‹ï¼Œé‚£ä¸ªæ€»æ˜¯åƒå¤ªé˜³ä¸€æ ·è€€çœ¼çš„å¥³å­©ï¼Œæ˜¯å¦ä¹Ÿæœ‰ä¸ä¸ºäººçŸ¥çš„é˜´æš—é¢ã€‚" },
        { mode: "nvl", text: "æ‰‹æœºéœ‡åŠ¨äº†ä¸€ä¸‹ã€‚", sfx: "sfx_notify.mp3" },
        { mode: "nvl", text: "åäº•å—é—­ä¸Šçœ¼æ·±å¸ä¸€å£æ°”ï¼Œä»¿ä½›è¦ä¸ºæ¥ä¸‹æ¥å¯èƒ½å‘ç”Ÿçš„ä»»ä½•äº‹æƒ…åšè¶³å‡†å¤‡ã€‚ç¿»è¿‡æ‰‹æœºï¼Œå±å¹•äº®èµ·â€”â€”" },
        { mode: "adv", name: "sana1229", text: "â€œçœŸçš„å—ï¼Ÿå¤ªè£å¹¸äº†ã€‚â€" },

        { mode: "nvl", text: "å‡‘å´çš„å›å¤æ¯”æƒ³è±¡ä¸­å¹³æ·¡ï¼Œåäº•å—ä¸ç¡®å®šè¿™æ˜¯å¥½äº‹è¿˜æ˜¯åäº‹ã€‚" },
        { mode: "nvl", text: "è£å¹¸ï¼Ÿè¿™ä¸ªè¯å¤ªå®¢æ°”äº†ï¼Œä¸åƒæ˜¯å‡‘å´å¹³æ—¶ä¼šç”¨çš„è¯­æ°”ã€‚" },
        { mode: "nvl", text: "å¥¹æŠŠè‡ªå·±æ‰”è¿›æŸ”è½¯çš„è¢«å­é‡Œï¼Œè„¸åŸ‹åœ¨æ•å¤´ä¸­ï¼Œé—·é—·åœ°ç¬‘å‡ºå£°ã€‚è¿™ä¸ªå‚»ç“œï¼Œå¯¹ç€ä¸€ä¸ªé™Œç”Ÿäººéƒ½èƒ½è¿™ä¹ˆç¤¼è²Œï¼Œè¿˜æ˜¯è¯´å¥¹åœ¨è¿™ç§æ—¶å€™åè€Œä¼šå˜å¾—æ‹˜è°¨ï¼Ÿ" },
        { mode: "nvl", text: "å¥¹æƒ³è±¡å‡‘å´çº±å¤æ­¤åˆ»çš„è¡¨æƒ…ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿå’Œå¥¹ä¸€æ ·å¿ƒè·³åŠ é€Ÿï¼Ÿé‚£ä¸ªæ€»æ˜¯å¤§å¤§å’§å’§çš„å¥³å­©ï¼Œä¼šå› ä¸ºä¸€å¼ æš§æ˜§çš„ç…§ç‰‡è€Œç´§å¼ å—ï¼Ÿ" },
        { mode: "nvl", text: "åäº•çªç„¶è§‰å¾—æœ‰ç‚¹å¥½ç¬‘ï¼Œä»å°åˆ°å¤§ï¼Œå¥¹éƒ½æ˜¯é‚£ä¸ªèº²åœ¨çª—å¸˜åé¢ï¼Œçœ‹ç€å‡‘å´æ— æ‰€é¡¾å¿Œåœ°å¥”è·‘ã€å¤§ç¬‘çš„äººã€‚è€Œç°åœ¨ï¼Œå¥¹ç«Ÿç„¶æˆäº†é‚£ä¸ªæŒæ¡ä¸»åŠ¨æƒçš„ä¸€æ–¹ã€‚" },

        { mode: "adv", name: "åäº•å—", text: "â€œä½ å–œæ¬¢å—ï¼Ÿâ€" },
        { mode: "nvl", text: "åäº•å—æ–Ÿé…Œäº†ä¸€ä¸‹ï¼ŒåˆåŠ äº†ä¸€å¥ã€‚" },
        { mode: "adv", name: "åäº•å—", text: "â€œæ›´å¤šçš„â€¦â€¦æƒ³è¦å—ï¼Ÿâ€" },
        { mode: "nvl", text: "å‘é€çš„ç¬é—´å¥¹åƒæ˜¯ç”¨å°½äº†å…¨èº«çš„åŠ›æ°”ï¼Œä»°é¢èººåœ¨åºŠä¸Šï¼Œå¬ç€è‡ªå·±çš„å¿ƒè·³å£°ï¼Œç«Ÿç„¶è§‰å¾—æœ‰äº›åˆºæ¿€ã€‚" },
        { mode: "nvl", text: "è¿™ä¸åƒå¥¹ï¼Œä¸€ç‚¹ä¹Ÿä¸åƒé‚£ä¸ªæˆç»©æ€»æ˜¯å¾ˆå¥½ã€è¢«è€å¸ˆå¤¸å¥–æ˜¯æ¨¡èŒƒç”Ÿçš„åäº•å—ã€‚å¯åäº•å—çŸ¥é“è‡ªå·±å¹³é™çš„è¡¨é¢ä¸‹è£…çš„æ˜¯ä»€ä¹ˆä¸œè¥¿ã€‚" },
        { mode: "nvl", text: "å¥¹å‡ ä¹æ˜¯åƒæœ¬èƒ½ä¸€æ ·æ¸´æœ›ç€å†’é™©å’Œåˆºæ¿€ï¼Œæ¸´æœ›ç€åƒå‡‘å´çº±å¤é‚£æ ·ï¼Œèƒ½å¤Ÿè‚†æ— å¿Œæƒ®åœ°åšè‡ªå·±æƒ³åšçš„äº‹ã€‚" },

        { mode: "nvl", text: "æ‰‹æœºéœ‡åŠ¨çš„å£°éŸ³æ¯”å¹³æ—¶æ›´å“äº®ï¼Œåäº•å—å‡ ä¹æ˜¯ç«‹åˆ»æŠ“èµ·æ¥çœ‹â€”â€”", sfx: "sfx_notify.mp3" },
        { mode: "adv", name: "sana1229", text: "â€œå–œæ¬¢ï¼å½“ç„¶æƒ³çœ‹ï¼â€" },

        // === åœºæ™¯ 8ï¼šåºŠä¸Šçš„ç…§ç‰‡ (å…³é”®åç»“å±€åˆ†æ”¯) ===
        { mode: "nvl", text: "è¿™æ¬¡çš„å›å¤å¸¦ç€æ˜æ˜¾çš„å…´å¥‹ã€‚" },
        { mode: "nvl", text: "åäº•å—èƒ½æƒ³è±¡å‡ºå‡‘å´çº±å¤æ‰“å­—æ—¶çš„æ ·å­ï¼Œå¯èƒ½å¾®å¾®ä¾§ç€å¤´ï¼Œå˜´è§’ä¸Šæ‰¬ï¼Œæ˜äº®çš„çœ¼ç›é—ªçƒç€æœŸå¾…çš„å…‰èŠ’ã€‚" },
        { mode: "nvl", text: "ä¸€ä¸ªå¿µå¤´çªç„¶æµ®ç°ï¼šå‡‘å´çº±å¤ååœ¨è‡ªå·±çš„æˆ¿é—´é‡Œï¼Œç›¯ç€æ‰‹æœºå±å¹•ï¼ŒæœŸå¾…ç€ä¸€ä¸ªå¥¹ä»¥ä¸ºæ˜¯é™Œç”Ÿäººçš„å›å¤ã€‚" },
        { mode: "nvl", text: "è¿™ä¸ªæƒ³æ³•è®©åäº•å—æ„Ÿåˆ°ä¸€ç§å¾®å¦™çš„æ»¡è¶³æ„Ÿï¼Œä»¿ä½›å¥¹ç»ˆäºåœ¨è¿™åœºä»å°å°±å¼€å§‹çš„ã€å•æ–¹é¢çš„æ³¨è§†ä¸­å äº†ä¸Šé£ã€‚" },
        { mode: "nvl", text: "å¥¹ä»åºŠä¸Šç«™èµ·æ¥ï¼Œå¯¹ç€é•œå­ç«¯è¯¦è‡ªå·±çš„èº«ä½“ã€‚" },
        { mode: "nvl", text: "å¥¹ä¸æƒ³å¤ªè¿‡éœ²éª¨ï¼Œé‚£æ ·å°±å¤±å»äº†è¯±æƒ‘çš„æ„å‘³ï¼Œä½†åˆä¸èƒ½å¤ªè¿‡ä¿å®ˆï¼Œæ¯•ç«Ÿå¥¹æƒ³çœ‹çœ‹å‡‘å´çº±å¤ä¼šæœ‰ä»€ä¹ˆååº”ã€‚" },
        { mode: "nvl", text: "æœ€ç»ˆå¥¹å†³å®šè¿˜æ˜¯ç©¿ç€è‡ªå·±çš„ç¡è£™ï¼Œèººåœ¨åºŠä¸Šï¼Œè®©è£™æ‘†è‡ªç„¶åœ°å †åœ¨å¤§è…¿ä¸Šï¼Œå¾®å¾®éœ²å‡ºä¸€ç‚¹å†…è£¤çš„è¾¹ç¼˜ã€‚" },
        { mode: "nvl", text: "å¥¹è°ƒæ•´äº†ä¸€ä¸‹ç¯å…‰ï¼Œè®©æˆ¿é—´é‡Œåªæœ‰ä¸€ç›æ˜é»„çš„åºŠå¤´ç¯äº®ç€ï¼Œæ‹¿èµ·æ‰‹æœºï¼Œè¯•äº†å‡ ä¸ªè§’åº¦ã€‚æŒ‘å“ªä¸€å¼ å¥½å‘¢" },

        {
            mode: "adv", type: "choice",
            options: [
                { text: "å°å¿ƒåœ°åªæ‹èº«ä½“ç‰¹å†™", next: "photo_safe_bed", effect: { sync: 2 } },
                { text: "å°½å¯èƒ½åœ°æ‹å¾—æ¼‚äº®ä¸€ç‚¹ï¼Œè¦æœ‰å…¨æ™¯", next: "bad_end_4", effect: { sync: 100 } }
            ]
        },

        // --- åˆ†æ”¯ï¼šæš´éœ²èº«ä»½ï¼ˆåç»“å±€ï¼‰ ---
        { label: "bad_end_4", mode: "nvl", text: "å¦‚æœè¦å‘ç»™çº±å¤çš„è¯ï¼Œæ— è®ºæ€ä¹ˆéƒ½å¾—æ‹å‡ºæœ€å¥½çœ‹çš„ç…§ç‰‡å§ï¼Ÿ", sfx: "sfx_camera.mp3" },
        { mode: "nvl", text: "åäº•å—è¿™æ ·æƒ³ç€ï¼Œé«˜é«˜åœ°ä¸¾èµ·äº†æ‰‹æœºï¼ŒæŠŠèº«ä½“çš„å…¨éƒ¨å§¿åŠ¿æ‹äº†è¿›å»ï¼Œåªæ˜¯é¿å¼€äº†è„¸éƒ¨ã€‚" },
        { mode: "nvl", text: "æ€€ç€å…´å¥‹è€Œä¸å®‰çš„å¿ƒæƒ…ï¼Œå¥¹æŒ‰ä¸‹äº†ç¡®è®¤é”®ã€‚" },
        { mode: "nvl", text: "è¿‡äº†ä¸€ä¼šå„¿ï¼Œå›å¤æ¥äº†ã€‚" },
        { mode: "adv", name: "sana1229", text: "â€œé‚£ä¸ªâ€¦â€¦ä¼é¹…ç©å¶ï¼Ÿâ€", bgm: "stop.mp3" },
        { mode: "adv", name: "sana1229", text: "â€œå—ï¼Ÿâ€" },
        { mode: "nvl", text: "åäº•å—çš„è¡€æ¶²ç¬é—´å‡å›ºäº†ã€‚é‚£æ˜¯å»å¹´ç”Ÿæ—¥çº±å¤é€ç»™å¥¹çš„ç¤¼ç‰©ï¼Œå°±åœ¨å¥¹çš„åºŠè¾¹æ”¾ç€ï¼Œå¤§åˆºåˆºåœ°å‡ºç°åœ¨äº†ç…§ç‰‡é‡Œã€‚å…¨ä¸–ç•Œç‹¬ä¸€æ— äºŒçš„å®šåˆ¶æ¬¾ã€‚" },
        { mode: "nvl", text: "æ‰‹æœºå¼€å§‹ç–¯ç‹‚éœ‡åŠ¨ï¼Œå±å¹•ä¸Šæ˜¾ç¤ºç€ã€å‡‘å´çº±å¤ æ¥ç”µã€‘ã€‚" },
        { mode: "nvl", text: "ä¸€åˆ‡éƒ½ç»“æŸäº†ï¼Œä»¥ä¸€ç§æœ€å°´å°¬çš„æ–¹å¼ã€‚" },
        { mode: "nvl", text: "ã€Bad Ending: ç¤¾æ­»ç°åœºã€‘" },
        { mode: "code", action: () => unlockEnding("identity_revealed") },
        { jump: "title_return" },


        // --- åˆ†æ”¯ï¼šå®‰å…¨è¿‡å…³ (æ¥å›åŸå‰§æƒ…) ---
        { label: "photo_safe_bed", mode: "nvl", text: "å¥¹å¾ˆè°¨æ…ï¼Œåªé€‰äº†ä¸€å¼ åªæ‹åˆ°äº†è‚©è†€åˆ°å¤§è…¿çš„ç…§ç‰‡ï¼ŒèƒŒæ™¯æ˜¯ä¸€ç‰‡æ¨¡ç³Šçš„é»‘æš—ã€‚", bgm: "bgm_dream_hazy.mp3" },
        { mode: "nvl", text: "ç…§ç‰‡é‡Œï¼Œå¥¹ç»†ç™½çš„æ‰‹æŒ‡è½»è½»æ‹‰ç€åŠå¸¦ï¼Œåƒæ˜¯éšæ—¶å¯èƒ½æ»‘è½ï¼Œå¦ä¸€åªæ‰‹åˆ™å¾®å¾®æ‹‰èµ·è£™æ‘†ï¼Œè‹¥éšè‹¥ç°åœ°éœ²å‡ºä¸€ç‚¹ç‚¹å†…è£¤çš„è•¾ä¸è¾¹ã€‚" },
        { mode: "nvl", text: "å¥¹ç‚¹å‡»å‘é€ï¼Œç„¶åç«‹åˆ»æŠŠæ‰‹æœºæ‰”åˆ°åºŠä¸Šï¼Œåƒæ˜¯åšäº†ä»€ä¹ˆåäº‹ä¸€æ ·ã€‚", sfx: "sfx_camera.mp3" },
        { mode: "nvl", text: "å¥¹æ„Ÿåˆ°ä¸€ç§å¥‡æ€ªçš„å…´å¥‹å’Œç¾è€»äº¤ç»‡çš„æƒ…ç»ªï¼Œæ—¢å¸Œæœ›å‡‘å´å–œæ¬¢ï¼Œåˆå®³æ€•å¥¹çš„ååº”ã€‚" },
        // === åœºæ™¯ 9ï¼šæœ€åçš„å¯¹è¯ ===
        { mode: "nvl", text: "ä¸åˆ°åç§’é’Ÿï¼Œå›å¤å°±æ¥äº†ã€‚", sfx: "sfx_notify.mp3" },
        { mode: "adv", name: "sana1229", text: "â€œâ€¦â€¦ä½ å¥½æ¼‚äº®ã€‚â€" },
        { mode: "adv", name: "sana1229", text: "â€œä½ åœ¨åšä»€ä¹ˆï¼Ÿæˆ‘æ˜¯è¯´ï¼Œç°åœ¨ï¼Ÿâ€" },

        { mode: "nvl", text: "åäº•å—æ„Ÿåˆ°è„¸é¢Šå‘çƒ­ï¼Œå¥¹å’¬ç€å˜´å”‡ï¼Œæƒ³äº†æƒ³ï¼Œæ§ç€æ‰‹æœºå¼€å§‹å›å¤ï¼š" },
        { mode: "adv", name: "åäº•å—", text: "â€œèººåœ¨åºŠä¸Šï¼Œæƒ³ç€ä½ å–œä¸å–œæ¬¢æˆ‘çš„ç…§ç‰‡ã€‚â€" },
        { mode: "nvl", text: "å¥¹åœé¡¿äº†ä¸€ä¸‹ï¼Œåˆè¡¥å……é“ï¼š" },
        { mode: "adv", name: "åäº•å—", text: "â€œä½ å‘¢ï¼Ÿâ€" },
        { mode: "nvl", text: "å‡‘å´çº±å¤çš„å›å¤è¿Ÿç–‘äº†ä¸€ä¸‹ã€‚" },
        { mode: "adv", name: "sana1229", text: "â€œæˆ‘â€¦â€¦åœ¨å®¶é‡Œã€‚â€", sfx: "sfx_notify.mp3" },
        { mode: "adv", name: "sana1229", text: "â€œä¹Ÿæ˜¯èººç€ï¼Œæƒ³ä½ ã€‚â€" },

        // === åœºæ™¯ 10ï¼šç»“å°¾ ===
        { mode: "nvl", text: "åäº•å—è½»ç¬‘å‡ºå£°ï¼Œæƒ³è±¡ç€å‡‘å´çº±å¤åç«‹ä¸å®‰çš„æ ·å­ã€‚", bgm: "stop" },
        { mode: "nvl", text: "å¥¹æœ›å‘çª—å¤–ï¼Œå‡‘å´çº±å¤çš„æˆ¿é—´å·²ç»æ²¡æœ‰ç¯å…‰äº†ã€‚", bg: "windows_night.jpg" },
        { mode: "nvl", text: "å¥¹çªç„¶æœ‰äº›æœŸå¾…æ˜å¤©åœ¨å­¦æ ¡è§åˆ°å¥¹æ—¶ï¼Œå‡‘å´ä¼šæ˜¯ä»€ä¹ˆè¡¨æƒ…ã€‚" },
        { mode: "nvl", text: "å¥¹ä¼šè¡¨ç°å¾—å’Œå¹³å¸¸ä¸€æ ·å—ï¼Ÿ" },
        { mode: "nvl", text: "è¿˜æ˜¯ä¼šå·å·åœ¨è¯¾é—´æ‹¿å‡ºæ‰‹æœºï¼Œçœ‹ç€é‚£äº›ç…§ç‰‡ï¼Œè„¸çº¢å¿ƒè·³ï¼Ÿ" , bgm: "stop"},
        
        { mode: "nvl", text: "â€”â€” ç¬¬äºŒç«  å®Œ â€”â€”" },
        { mode: "code", action: () => {
             if(!gameProgress.unlockedChapters.includes(3)) {
                gameProgress.unlockedChapters.push(3);
                saveSystemData();
             }
        }},
        { jump: "title_return" },

        // === ã€ä¿®å¤ã€‘è¿™é‡Œå®šä¹‰é€šç”¨çš„â€œè¿”å›æ ‡é¢˜â€æ ‡ç­¾ ===
        { label: "title_return", jump: -1 } 
    ]; // <--- ç¡®ä¿è¿™è¡Œ ] ä¾ç„¶æ˜¯æ•´ä¸ªæ•°ç»„çš„ç»“å°¾

    
    /* =========================================
       3. æ ¸å¿ƒå¼•æ“
       ========================================= */
    
    let isTyping = false, typeTimer = null, fullText = "";
    let currentMode = "adv"; 
    let isChoosing = false; 
    let isSkipping = false;
    let skipInterval = null;
    let longPressTimer = null;

    window.onload = () => {
        // å…ˆæŒ‚è½½ç›‘å¬å™¨ï¼Œä¿è¯æ¸¸æˆèƒ½ç‚¹
        const container = document.getElementById('game-container');
        let isTouch = false;

        const handleInteraction = (e) => {
            const target = e.target;
            // é˜²è¯¯è§¦ä¿æŠ¤
            if (target.closest('button') || target.closest('.chapter-card') || 
                target.closest('.lib-branch-btn') || target.closest('.settings-box') || 
                target.closest('.choice-btn') || target.closest('.slot-card') ||
                document.getElementById('menu-overlay').style.display === 'flex') return;
            
            longPressTimer = setTimeout(startSkip, 400);
        };

        const handleEnd = (e) => {
            clearTimeout(longPressTimer);
            if (isSkipping) {
                stopSkip();
            } else {
                const target = e.target;
                if (!target.closest('button') && !target.closest('.chapter-card') && !target.closest('.end-card') && !target.closest('.lib-branch-btn') && !target.closest('.setting-slider') && !target.closest('.choice-btn')) {
                    handleClick();
                }
            }
        };

        container.addEventListener('mousedown', (e) => { 
            if(isTouch) return;
            if(e.button===0) handleInteraction(e); 
        });
        container.addEventListener('mouseup', (e) => {
            if(isTouch) return;
            handleEnd(e);
        });

        container.addEventListener('touchstart', (e) => { 
            isTouch = true;
            handleInteraction(e); 
        }, {passive: true});

        container.addEventListener('touchend', (e) => {
            handleEnd(e);
            setTimeout(() => isTouch = false, 500);
        });
// === ã€æ–°å¢ã€‘èµ„æºé¢„åŠ è½½ ===
        const preloadAssets = () => {
            const images = [];
            // 1. æå–å‰§æœ¬ä¸­çš„èƒŒæ™¯å›¾
            script.forEach(line => {
                if (line.bg && !line.bg.startsWith('#')) images.push(line.bg);
                // å¦‚æœä½ çš„ script é‡Œå°†æ¥æœ‰ char å±æ€§æŒ‡å®šå›¾ç‰‡è·¯å¾„ï¼Œä¹Ÿè¦åŠ åœ¨è¿™é‡Œ
            });
            // 2. æå– CSS ä¸­çš„ç«‹ç»˜ (æ‰‹åŠ¨æŒ‡å®šï¼Œå› ä¸ºæ— æ³•ç›´æ¥è¯» CSS)
            images.push(
                'https://via.placeholder.com/400x800/f9e4ff/9d72b0?text=Sana',
                'https://via.placeholder.com/400x800/c4ffdd/56ab83?text=Mina'
            );
            
            // å¼€å§‹é™é»˜åŠ è½½
            images.forEach(src => {
                const img = new Image();
                img.src = src;
            });
        };
        preloadAssets();
        // === é¢„åŠ è½½ç»“æŸ ===

        resizeGame();
        window.addEventListener('resize', resizeGame);
        loadSystemData();
        
        window.addEventListener('beforeunload', () => {
             if (document.getElementById('title-screen').style.display === 'none') performSave(1);
        });
    };

    function resizeGame() {
        const container = document.getElementById('game-container');
        const scale = Math.min(window.innerWidth / 960, window.innerHeight / 540);
        container.style.transform = `scale(${scale})`;
    }

    function startSkip() {
        if (isChoosing || document.getElementById('title-screen').style.display !== 'none') return;
        isSkipping = true;
        document.getElementById('skip-indicator').style.display = 'block';
        skipInterval = setInterval(() => {
            if(isChoosing) stopSkip();
            else if(isTyping) {
                clearInterval(typeTimer);
                if (currentMode === 'nvl') document.getElementById('nvl-content').innerHTML = fullText;
                else document.getElementById('text-box').innerHTML = fullText;
                isTyping = false;
            } else nextStep();
        }, 80);
    }


    function stopSkip() {
        isSkipping = false;
        clearInterval(skipInterval);
        document.getElementById('skip-indicator').style.display = 'none';
    }

    function resetGame() {
        gameState = JSON.parse(JSON.stringify(initialGameState));
        document.getElementById('nvl-layer').style.display = 'none';
        document.getElementById('adv-box').style.opacity = '1';
        document.getElementById('history-list').innerHTML = "";
    }

    function startGame() {
        resetGame();
        document.getElementById('title-screen').style.display = 'none';
        renderScene();
    }

function openChapters() { 
        document.getElementById('chapter-overlay').style.display = 'flex';
        
        // è·å–æ‰€æœ‰å¡ç‰‡
        const cards = document.querySelectorAll('.chapter-card');
        
        // === æ£€æŸ¥ç¬¬ 2 ç«  (æ•°ç»„ä¸‹æ ‡æ˜¯ 1) ===
        // å¦‚æœè§£é”åˆ—è¡¨ä¸­åŒ…å« 2
        if (gameProgress.unlockedChapters.includes(2)) {
            const ch2 = cards[1]; 
            ch2.classList.remove('locked'); // å»æ‰ç°è‰²é”å®šæ ·å¼
            ch2.querySelector('.ch-title').innerText = "â€œä¸æ˜¯çš„ï¼Œåªæœ‰ä½ â€"; // åŠ¨æ€ä¿®æ”¹æ ‡é¢˜
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            ch2.onclick = (e) => { 
                e.stopPropagation(); 
                startChapter('ch2_start'); 
            };
        }
        
        // å¦‚æœæœªæ¥æœ‰ç¬¬ 3 ç« ï¼Œå°±åœ¨è¿™é‡Œç»§ç»­åŠ  if (includes(3))...
    }
/* =========================================
   é˜…è§ˆå®¤é€»è¾‘ (æ™ºèƒ½å‰ç¼€ç‰ˆï¼šé€‚é… bad_end_x)
   ========================================= */

let libraryData = [];

function openLibrary() {
    const container = document.getElementById('library-content');
    container.innerHTML = "";
    libraryData = []; 

    // 1. å¦‚æœå®Œå…¨æ²¡è¯»è¿‡å‰§æƒ…
    if (!gameProgress.readLines || gameProgress.readLines.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#999; margin-top:50px;">
            <div style="font-size:40px; margin-bottom:20px;">ğŸ“–</div>
            å°šæœªè§£é”ä»»ä½•å‰§æƒ…ã€‚<br>è¯·å…ˆè¿›è¡Œæ¸¸æˆã€‚
        </div>`;
        document.getElementById('library-overlay').style.display = 'flex';
        return;
    }

    // 2. éå†å‰§æœ¬
    let currentChTitle = "åºç« ";
    let currentChContent = "";
    let hasContent = false;

    // è¾…åŠ©ï¼šæŠŠå½“å‰ç« èŠ‚å­˜å…¥æ•°ç»„
    const flushChapter = () => {
        if (hasContent) {
            libraryData.push({ title: currentChTitle, html: currentChContent });
        }
        currentChContent = "";
        hasContent = false;
    };

    for (let i = 0; i < script.length; i++) {
        const line = script[i];

        // --- ã€ä¿®å¤ã€‘ç« èŠ‚åˆ¤æ–­é€»è¾‘ ---
        // å¿…é¡»ä»¥ ch å¼€å¤´ ä¸” ä»¥ _start ç»“å°¾
        // è¿™æ · 'search_loop_start' å°±ä¸ä¼šè¢«è¯¯åˆ¤äº†ï¼Œç¬¬äºŒç« ä¸ä¼šæ–­å¼€ï¼
        if (line.label && line.label.startsWith('ch') && line.label.endsWith('_start')) {
            flushChapter(); 
            if (line.label === 'ch1_start') currentChTitle = "ç¬¬ä¸€ç« ";
            if (line.label === 'ch2_start') currentChTitle = "ç¬¬äºŒç« ";
            if (line.label === 'ch3_start') currentChTitle = "ç¬¬ä¸‰ç« ";
            // ...ä»¥æ­¤ç±»æ¨
        }

        // å¦‚æœæœªè¯»è¿‡è¯¥è¡Œï¼Œç›´æ¥è·³è¿‡
        if (!gameProgress.readLines.includes(i)) continue;

        // --- ã€æ ¸å¿ƒã€‘æ™ºèƒ½æŠ˜å åç»“å±€ ---
        // åªè¦æ ‡ç­¾æ˜¯ä»¥ "bad_end" å¼€å¤´çš„ (æ¯”å¦‚ bad_end_1, bad_end_doll)
        // ç³»ç»Ÿå°±ä¼šè‡ªåŠ¨æŠŠå®ƒè¯†åˆ«ä¸ºåˆ†æ”¯ç»“å±€ï¼Œå¹¶æŠ˜å èµ·æ¥
        if (line.label && line.label.startsWith('bad_end')) {
            // å¼€å§‹è·³è¿‡ï¼Œç›´åˆ°é‡åˆ° 'title_return'
            let tempI = i;
            let foundReturn = false;
            while (tempI < script.length) {
                if (script[tempI].jump === 'title_return') {
                    foundReturn = true;
                    break;
                }
                tempI++;
            }
            if (foundReturn) {
                i = tempI; // ç›´æ¥è·³åˆ°ç»“å°¾ï¼Œä¸­é—´çš„å†…å®¹ä¸æ˜¾ç¤ºåœ¨ä¸»ç•Œé¢
            }
            continue; 
        }
        
        // è·³è¿‡ä»£ç å—
        if (line.mode === 'code') continue;

        // ç”Ÿæˆæ­£æ–‡ HTML
        if (line.text && (line.mode === 'nvl' || line.mode === 'adv' || !line.mode)) {
            hasContent = true;
            if (line.name) {
                currentChContent += `<div class="lib-p"><span class="lib-name">${line.name}</span>${line.text}</div>`;
            } else {
                currentChContent += `<div class="lib-p">${line.text}</div>`;
            }
        }

        // --- ã€æ ¸å¿ƒã€‘ç”Ÿæˆåˆ†æ”¯æŒ‰é’® ---
        if (line.type === 'choice') {
            line.options.forEach(opt => {
                // æ£€æŸ¥é€‰é¡¹çš„ç›®æ ‡æ˜¯å¦æ˜¯ä»¥ bad_end å¼€å¤´
                if (opt.next && opt.next.startsWith('bad_end')) {
                    
                    // åˆ¤æ–­è§£é”çŠ¶æ€ï¼šåªè¦è¯»è¿‡è¯¥ç»“å±€çš„ç¬¬ä¸€è¡Œ
                    const targetIdx = script.findIndex(s => s.label === opt.next);
                    const isUnlocked = targetIdx !== -1 && gameProgress.readLines.includes(targetIdx);

                    if (isUnlocked) {
                        // è¿™é‡Œçš„ opt.next å°±æ˜¯ä½ åœ¨å‰§æœ¬é‡Œå†™çš„ bad_end_x
                        currentChContent += `<div class="lib-branch-btn" onclick="showBranchText('${opt.next}')">âš¡ ã€åˆ†æ”¯å‰§æƒ…ã€‘ç‚¹å‡»æŸ¥çœ‹</div>`;
                        hasContent = true;
                    } else {
                        currentChContent += `<div class="lib-branch-btn lib-locked">ğŸ”’ ã€åˆ†æ”¯ã€‘??? (æœªè§£é”)</div>`;
                        hasContent = true;
                    }
                }
            });
        }
    }
    // å¾ªç¯ç»“æŸï¼Œå­˜å…¥æœ€åä¸€ç« 
    flushChapter();

    // 3. æ¸²æŸ“ UI
    if (libraryData.length === 0) return;

    let tabsHtml = `<div class="lib-tabs">`;
    libraryData.forEach((ch, index) => {
        tabsHtml += `<div class="lib-tab ${index === 0 ? 'active' : ''}" onclick="switchLibTab(${index}, this)">${ch.title}</div>`;
    });
    tabsHtml += `</div>`;

    let contentHtml = `<div id="lib-display-area" class="lib-content-area">${libraryData[0].html}</div>`;

    container.innerHTML = tabsHtml + contentHtml;
    document.getElementById('library-overlay').style.display = 'flex';
}

// === æ–°å¢ï¼šåˆ‡æ¢æ ‡ç­¾å‡½æ•° ===
function switchLibTab(index, btnElement) {
    // 1. åˆ‡æ¢å†…å®¹
    const displayArea = document.getElementById('lib-display-area');
    if (libraryData[index]) {
        displayArea.innerHTML = libraryData[index].html;
        // æ»šå›åˆ°é¡¶éƒ¨
        document.querySelector('.library-container').scrollTop = 0;
    }

    // 2. åˆ‡æ¢æ ‡ç­¾é«˜äº®çŠ¶æ€
    const allTabs = document.querySelectorAll('.lib-tab');
    allTabs.forEach(tab => tab.classList.remove('active'));
    btnElement.classList.add('active');
}

function showBranchText(label) {
    let html = "";
    // æ‰¾åˆ°æ ‡ç­¾æ‰€åœ¨çš„è¡Œ
    let startIdx = script.findIndex(i => i.label === label);
    
    if (startIdx !== -1) {
        // ä»æ ‡ç­¾å¼€å§‹å¾€åè¯»
        for (let i = startIdx; i < script.length; i++) {
            const line = script[i];
            
            // é‡åˆ°è·³å›æ ‡é¢˜çš„æŒ‡ä»¤ï¼Œè¯´æ˜ç»“å±€ç»“æŸ
            if (line.jump === 'title_return') break;
            
            // æ”¶é›†æ–‡æœ¬
            if (line.text) {
                if (line.name) {
                    html += `<div class="lib-p"><span class="lib-name">${line.name}</span>${line.text}</div>`;
                } else {
                    html += `<div class="lib-p">${line.text}</div>`;
                }
            }
        }
    } else {
        html = "<div style='text-align:center; padding:50px;'>âš ï¸ é”™è¯¯ï¼šæœªæ‰¾åˆ°å¯¹åº”çš„å‰§æƒ…ç‰‡æ®µã€‚</div>";
    }

    const modal = document.getElementById('branch-modal');
    // å…ˆæ¸…ç©ºï¼Œå†å¡«å…¥
    document.getElementById('branch-content').innerHTML = ""; 
    document.getElementById('branch-content').innerHTML = html;
    
    modal.style.display = 'block';
    document.getElementById('branch-modal-overlay').style.display = 'block';
}

function closeBranchModal() {
    document.getElementById('branch-modal').style.display = 'none';
    document.getElementById('branch-modal-overlay').style.display = 'none';
}

    /* =========================================
       4. éŸ³é¢‘ç³»ç»Ÿ
       ========================================= */
    const audioSystem = { 
        bgm: new Audio(), 
        currentSfx: null, 
        currentBgmUrl: "" 
    };
    audioSystem.bgm.loop = true; 

   function playBgm(url) {
        if (!url) return;
        if (audioSystem.currentBgmUrl === url) return; 
        
        audioSystem.bgm.src = url;
        // ã€æ–°å¢ã€‘ç¡®ä¿æ’­æ”¾æ—¶åº”ç”¨å½“å‰çš„å…¨å±€éŸ³é‡é…ç½®
        audioSystem.bgm.volume = systemConfig.bgmVolume; 
        
        audioSystem.bgm.play().catch(e => console.log("ç­‰å¾…äº¤äº’æ’­æ”¾éŸ³ä¹"));
        audioSystem.currentBgmUrl = url;
    }
    function stopBgm() { audioSystem.bgm.pause(); audioSystem.currentBgmUrl = ""; }
    
    function playSfx(url) {
        if (!url) return;
        if (audioSystem.currentSfx) { audioSystem.currentSfx.pause(); audioSystem.currentSfx = null; }
        const sfx = new Audio(url); 
        sfx.volume = systemConfig.sfxVolume;
        sfx.play().catch(e => console.log("ç­‰å¾…äº¤äº’æ’­æ”¾éŸ³æ•ˆ"));
        audioSystem.currentSfx = sfx;
        sfx.onended = () => { audioSystem.currentSfx = null; };
    }

    function stopAllAudio() {
        stopBgm();
        if (audioSystem.currentSfx) { audioSystem.currentSfx.pause(); audioSystem.currentSfx = null; }
    }

    /* =========================================
       5. æ¸²æŸ“é€»è¾‘
       ========================================= */
    function renderScene() {
    if (gameState.idx >= script.length) return;

    // ã€æ ¸å¿ƒä¿®å¤ã€‘åªè¦æ˜¾ç¤ºè¿™ä¸€è¡Œï¼Œå°±ç«‹åˆ»è®°å…¥â€œå·²è¯»â€ï¼Œå¹¶å¼ºåˆ¶ä¿å­˜ç³»ç»Ÿå­˜æ¡£
    // è¿™æ ·å“ªæ€•ä½ ç«‹åˆ»å…³é—­æµè§ˆå™¨ï¼Œè¿›åº¦ä¹Ÿå·²ç»è®°ä½äº†
    if (!gameProgress.readLines.includes(gameState.idx)) {
        gameProgress.readLines.push(gameState.idx);
        saveSystemData(); 
    }

    const line = script[gameState.idx];

        if (line.mode === 'code') { line.action(); nextStep(); return; }

        if (line.jump !== undefined) {
            if (line.jump === -1) { document.getElementById('title-screen').style.display = 'flex'; return; }
            if (typeof line.jump === 'string') gameState.idx = script.findIndex(i => i.label === line.jump);
            else gameState.idx = line.jump;
            renderScene(); return;
        }

        if (line.bg) gameState.currentBg = line.bg;
        if (line.bgm) gameState.currentBgm = line.bgm;
        if (line.show) gameState.currentShow = line.show;

        const bgDiv = document.querySelector('.bg-layer');
        if(gameState.currentBg.startsWith('#')) { bgDiv.style.backgroundImage = 'none'; bgDiv.style.backgroundColor = gameState.currentBg; } 
        else { bgDiv.style.backgroundImage = `url('${gameState.currentBg}')`; }

        if (gameState.currentBgm) {
            if (gameState.currentBgm === "stop") stopBgm();
            else playBgm(gameState.currentBgm);
        }

        const activeChars = gameState.currentShow || [];
        ['sana', 'mina'].forEach(char => {
            const el = document.getElementById(`char-${char}`);
            if (activeChars.includes(char)) {
                el.style.display = 'block';
                if (!line.focus || line.focus === char) el.className = 'char-img active';
                else el.className = 'char-img inactive';
            } else { el.style.display = 'none'; }
        });

        const nvl = document.getElementById('nvl-layer');
        const adv = document.getElementById('adv-box');

        if (line.type === 'choice') { adv.style.pointerEvents = 'none'; showChoice(line.options); return; }

        if (line.text && (!gameState.logs.length || gameState.logs[gameState.logs.length-1].text !== line.text)) {
            gameState.logs.push({ name: line.name || "", text: line.text });
        }

        document.querySelectorAll('.cursor').forEach(c => c.classList.remove('show'));
        if (line.sfx) playSfx(line.sfx);

        if (line.mode === 'nvl') {
            currentMode = 'nvl'; nvl.style.display = 'flex'; adv.style.opacity = '0'; adv.style.pointerEvents = 'none';
            document.getElementById('nvl-content').innerHTML = line.text || ""; 
            document.getElementById('nvl-cursor').classList.add('show');
            isTyping = false;
        } else if (line.text) { 
            currentMode = 'adv'; nvl.style.display = 'none'; adv.style.opacity = '1'; adv.style.pointerEvents = 'auto'; 
            const nameBox = document.getElementById('name-box');
            nameBox.innerText = line.name || ""; nameBox.className = "";
            if(line.name === "å‡‘å´çº±å¤") nameBox.classList.add("name-sana");
            if(line.name === "åäº•å—") nameBox.classList.add("name-mina");
            typeWriter(document.getElementById('text-box'), line.text);
        } else {
            currentMode = 'bg_only'; nvl.style.display = 'none'; adv.style.opacity = '0'; adv.style.pointerEvents = 'auto'; isTyping = false;
        }
    }

    function typeWriter(element, text) {
        element.innerHTML = ""; fullText = text || ""; 
        let i = 0; isTyping = true;
        clearInterval(typeTimer);
        if (isSkipping) { element.innerHTML = fullText; finishTyping(); return; }
        typeTimer = setInterval(() => {
            if(i >= fullText.length) { finishTyping(); return; }
            element.innerHTML += fullText.charAt(i); i++;
        }, 30);
        function finishTyping() {
            clearInterval(typeTimer); isTyping = false;
            if (currentMode === 'nvl') document.getElementById('nvl-cursor').classList.add('show');
            else document.getElementById('adv-cursor').classList.add('show');
        }
    }

    function nextStep() { gameState.idx++; if (gameState.idx < script.length) renderScene(); }

    function handleClick() {
        if (document.getElementById('choice-overlay').style.display === 'flex') return;
        if (isTyping) {
            clearInterval(typeTimer);
            if (currentMode === 'nvl') document.getElementById('nvl-content').innerHTML = fullText;
            else document.getElementById('text-box').innerHTML = fullText;
            isTyping = false;
            if (currentMode === 'nvl') document.getElementById('nvl-cursor').classList.add('show');
            else document.getElementById('adv-cursor').classList.add('show');
        } else { nextStep(); }
    }

    function showChoice(options) {
        isChoosing = true; stopSkip();
        const layer = document.getElementById('choice-overlay');
        layer.innerHTML = ""; layer.style.display = "flex";
        options.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = "choice-btn"; btn.innerText = opt.text;
            btn.onclick = (e) => {
                e.stopPropagation();
                if(opt.effect) {
                    gameState.stats.love += opt.effect.love || 0;
                    gameState.stats.lust += opt.effect.lust || 0;
                    gameState.stats.sync += opt.effect.sync || 0;
                }
                layer.style.display = "none";
                if (typeof opt.next === 'string') gameState.idx = script.findIndex(i => i.label === opt.next);
                else gameState.idx = opt.next;
                isChoosing = false; renderScene();
            }
            layer.appendChild(btn);
        });
    }

    let currentOperation = 'save';

    function openGameMenu() { currentOperation = 'save'; openSaveMenu('menu'); }

    function openSaveMenu(mode) {
        document.getElementById('menu-overlay').style.display = 'flex';
        document.getElementById('menu-title').innerText = (mode === 'load') ? "è¯»å–è¿›åº¦" : "ç³»ç»Ÿèœå•";
        currentOperation = mode;
        document.querySelector('.settings-box').style.display = (mode === 'menu') ? 'block' : 'none';
        renderSlots();
    }
function renderSlots() {
        const container = document.getElementById('slots-container');
        container.innerHTML = "";
        for(let i=1; i<=3; i++) {
            const data = localStorage.getItem('sana_jump_save_' + i);
            const card = document.createElement('div');
            card.className = "slot-card";
            
            if(data) {
                try {
                    const parsed = JSON.parse(data);
                    card.innerHTML = `
                        <div class="slot-id">FILE 0${i}</div>
                        <div class="slot-preview">${parsed.preview}</div>
                        <div class="slot-date">${parsed.date}</div>
                    `;
                } catch(e) {
                    card.innerHTML = `<div class="slot-id">FILE 0${i}</div><div class="slot-preview">æ•°æ®æŸå</div>`;
                }
            } else {
                card.innerHTML = `
                    <div class="slot-id">FILE 0${i}</div>
                    <div class="slot-preview" style="color:#ccc; display:flex; align-items:center; justify-content:center; height:100%;">
                        ${currentOperation === 'save' ? 'ç‚¹å‡»å­˜æ¡£' : 'ç©ºè®°å½•'}
                    </div>
                `;
            }
            
            card.onclick = (e) => {
                e.stopPropagation();
                handleSlotClick(i);
            };
            container.appendChild(card);
        }
    }
    function closeMenu() { document.getElementById('menu-overlay').style.display = 'none'; }
    
 // === ã€ä¿®å¤ã€‘æ›´å¼ºå£®çš„å­˜æ¡£å‡½æ•° ===
    function performSave(slotId) {
        let textToSave = "å‰§æƒ…ç‰‡æ®µ";
        // å°è¯•è·å–å½“å‰æ–‡æœ¬ç”¨äºé¢„è§ˆ
        if (script[gameState.idx] && script[gameState.idx].text) {
            textToSave = script[gameState.idx].text;
        } else if (gameState.logs.length > 0) {
            textToSave = gameState.logs[gameState.logs.length - 1].text;
        }

        // --- æ ¸å¿ƒä¿®å¤å¼€å§‹ï¼šè®¡ç®—é”šç‚¹ ---
        let anchorLabel = null;
        let offset = 0;
        // å‘ä¸Šå¯»æ‰¾æœ€è¿‘çš„ä¸€ä¸ªæ ‡ç­¾ (label)
        for (let i = gameState.idx; i >= 0; i--) {
            if (script[i].label) {
                anchorLabel = script[i].label;
                offset = gameState.idx - i;
                break;
            }
        }
        // å°†é”šç‚¹ä¿¡æ¯å†™å…¥ gameState
        gameState.anchorLabel = anchorLabel;
        gameState.anchorOffset = offset;
        // --- æ ¸å¿ƒä¿®å¤ç»“æŸ ---

        const saveObj = { 
            state: gameState, 
            date: new Date().toLocaleString(), 
            preview: textToSave.substring(0, 20) + (textToSave.length>20?"...":"") 
        };
        
        try {
            localStorage.setItem('sana_jump_save_' + slotId, JSON.stringify(saveObj));
            // å¢åŠ ä¿å­˜æˆåŠŸçš„è§†è§‰åé¦ˆï¼ˆå¯é€‰ï¼‰
            if(document.getElementById('menu-overlay').style.display === 'flex') {
                const btn = document.querySelectorAll('.slot-card')[slotId-1];
                btn.style.borderColor = '#56ab83'; // å˜ç»¿æç¤ºæˆåŠŸ
                setTimeout(()=>btn.style.borderColor = '#ddd', 500);
            }
        } catch (e) {
            alert("å­˜æ¡£å¤±è´¥ï¼šå¯èƒ½æ˜¯æµè§ˆå™¨å­˜å‚¨ç©ºé—´å·²æ»¡");
        }
    }

    // === ã€ä¿®å¤ã€‘æ›´æ™ºèƒ½çš„è¯»æ¡£å‡½æ•° ===
    function handleSlotClick(slotId) {
        if (currentOperation === 'load') {
            const data = localStorage.getItem('sana_jump_save_' + slotId);
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    gameState = parsed.state;
                    
                    // --- æ ¸å¿ƒä¿®å¤å¼€å§‹ï¼šé€šè¿‡é”šç‚¹ä¿®æ­£è¡Œå· ---
                    if (gameState.anchorLabel) {
                        const labelIdx = script.findIndex(i => i.label === gameState.anchorLabel);
                        if (labelIdx !== -1) {
                            // é‡æ–°è®¡ç®—æ­£ç¡®çš„ idx
                            gameState.idx = labelIdx + gameState.anchorOffset;
                        } else {
                            console.warn("åŸå­˜æ¡£çš„æ ‡ç­¾å·²ä¸¢å¤±ï¼Œå°è¯•ä½¿ç”¨æ—§è¡Œå·åŠ è½½...");
                        }
                    }
                    // --- æ ¸å¿ƒä¿®å¤ç»“æŸ ---

                    closeMenu();
                    document.getElementById('title-screen').style.display = 'none';
                    
                    // æ¢å¤èƒŒæ™¯å’Œç«‹ç»˜çŠ¶æ€
                    const bgDiv = document.querySelector('.bg-layer');
                    if(gameState.currentBg.startsWith('#')) {
                        bgDiv.style.backgroundImage = 'none';
                        bgDiv.style.backgroundColor = gameState.currentBg;
                    } else {
                        bgDiv.style.backgroundImage = `url('${gameState.currentBg}')`;
                    }
                    
                    // æ¢å¤ BGM (å¦‚æœéœ€è¦)
                    if(gameState.currentBgm && gameState.currentBgm !== "stop") {
                         playBgm(gameState.currentBgm);
                    } else {
                         stopBgm();
                    }

                    renderScene();
                } catch(e) {
                    console.error(e);
                    alert("å­˜æ¡£æ–‡ä»¶æŸåï¼Œæ— æ³•è¯»å–ã€‚");
                }
            } else { 
                alert("è¿™é‡Œæ˜¯ç©ºçš„ã€‚");
            }
        } else {
            if(confirm(`è¦è¦†ç›– å­˜æ¡£ ${slotId} å—ï¼Ÿ`)) {
                performSave(slotId);
                renderSlots();
            }
        }
    }

    function quitTitle() {
        if(confirm("ç¡®å®šè¦è¿”å›æ ‡é¢˜ç”»é¢å—ï¼Ÿ(æœªä¿å­˜çš„è¿›åº¦å°†ä¸¢å¤±)")) {
            stopAllAudio(); 
            location.reload();
        }
    }

    function showStats() {
        document.getElementById('val-love').innerText = gameState.stats.love;
        document.getElementById('val-lust').innerText = gameState.stats.lust;
        document.getElementById('val-sync').innerText = gameState.stats.sync;
        document.getElementById('bar-love').style.width = Math.min(gameState.stats.love * 2, 100) + "%";
        document.getElementById('bar-lust').style.width = Math.min(gameState.stats.lust * 2, 100) + "%";
        document.getElementById('bar-sync').style.width = Math.min(gameState.stats.sync * 2, 100) + "%";
        document.getElementById('stats-overlay').style.display = 'flex';
    }

    function showHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = "";
        gameState.logs.forEach(log => {
            const item = document.createElement('div');
            item.className = 'log-item';
            const nameHtml = log.name ? `<div class="log-name">${log.name}</div>` : "";
            item.innerHTML = `${nameHtml}<div class="log-text">${log.text}</div>`;
            list.appendChild(item);
        });
        document.getElementById('history-overlay').style.display = 'flex';
        setTimeout(() => list.scrollTop = list.scrollHeight, 10);
    }

</script>
</body>
</html>
